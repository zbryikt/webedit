function import$(t,o){var e={}.hasOwnProperty;for(var r in o)e.call(o,r)&&(t[r]=o[r]);return t}var collab,x$;collab={action:{info:function(t){var o,e,r,l,i;if(o=[t,collab.doc],e=o[0],r=o[1],!r||!r.data)return[];for(;e&&e.parentNode&&!e.getAttribute("base-block");)e=e.parentNode;return e&&e.getAttribute&&e.getAttribute("base-block")?(l=Array.from(e.parentNode.childNodes).indexOf(e),i=e.getAttribute("base-block"),[e,r,l,i]):[]},setTitle:function(t){return this.setTitle.handler&&(clearTimeout(this.setTitle.handler),this.setTitle.handler=null),this.setTitle.handler=setTimeout(function(){var o,e,r,l;return o=collab.doc,e=t,e||(r=Array.from(document.querySelector("#editor .inner").querySelectorAll("h1,h2,h3")),r.sort(function(t,o){return t.nodeName===o.nodeName?0:t.nodeName>o.nodeName?1:-1}),e=r[0].innerText),e||(e="untitled"),o.data.attr.title!==e?(e.length>60&&(e=e.substring(0,57)+"..."),o.data.attr.title?(o.submitOp([{p:["attr","title",0],sd:o.data.attr.title}]),o.submitOp([{p:["attr","title",0],si:e}])):o.submitOp([{p:["attr"],oi:(l=import$({},o.data.attr),l.title=e,l)}])):void 0},1e3)},moveBlock:function(t,o){return collab.doc.submitOp([{p:["child",t],lm:o}])},deleteBlock:function(t){var o,e,r,l,i;return o=this.info(t),e=o[0],r=o[1],l=o[2],i=o[3],e?r.submitOp([{p:["child",l],ld:r.data.child[l]}]):void 0},insertBlock:function(t){var o,e,r,l,i;return o=this.info(t),e=o[0],r=o[1],l=o[2],i=o[3],e?(r.submitOp([{p:["child",l],li:{content:this.blockContent(e),type:i}}]),this.setTitle()):void 0},blockContent:function(t){var o;return o=Array.from(t.childNodes).filter(function(t){return/inner/.exec(t.getAttribute("class"))})[0],o.querySelector("[auto-content]")&&(o=o.cloneNode(!0),Array.from(o.querySelectorAll("[auto-content]")).map(function(t){return Array.from(t.childNodes).map(function(o){return t.removeChild(o)})})),(o||{}).innerHTML},strDiff:function(t,o,e){var r,l,i,n,a,c,d,s=[];for(null==t&&(t=[]),null==o&&(o=""),null==e&&(e=""),r=[collab.doc,fastDiff(o,e),0],l=r[0],i=r[1],n=r[2],a=0,c=i.length;c>a;++a)d=i[a],0===d[0]?s.push(n+=d[1].length):1===d[0]?(l.submitOp([{p:t.concat([n]),si:d[1]}]),s.push(n+=d[1].length)):s.push(l.submitOp([{p:t.concat([n]),sd:d[1]}]));return s},editStyle:function(t,o){var e,r,l,i,n,a,c,d;if(null==o&&(o=!1),e=collab.doc,o)r=[e.data,[]],l=r[0],i=r[1];else{if(r=this.info(t),n=r[0],e=r[1],a=r[2],c=r[3],!n||!e.data.child[a])return;r=[e.data.child[a],["child",a]],l=r[0],i=r[1]}return d=t.getAttribute("style"),l.style?this.strDiff(i.concat(["style"]),l.style,d):e.submitOp([{p:i,ld:l,li:(r=import$({},l),r.style=d,r)}])},editBlock:function(t){var o,e,r,l,i,n,a,c;return o=this.info(t),e=o[0],r=o[1],l=o[2],i=o[3],e?(n={last:(r.data.child[l]||{}).content||"",now:this.blockContent(e)},a=fastDiff(n.last,n.now),r.data.child[l]||r.submitOp([{p:["child",l],li:{content:"",type:i,style:""}}]),c=0,this.strDiff(["child",l,"content"],n.last,n.now),this.setTitle()):void 0},cursor:function(t,o){return t&&collab.doc&&collab.doc.data?collab.doc.submitOp([{p:["collaborator",t.key,"cursor"],od:collab.doc.data.collaborator[t.key].cursor,oi:o}]):void 0},join:function(t){var o;if(collab.doc&&collab.doc.data)return t||(t={displayname:"guest",key:Math.random().toString(16).substring(2),guest:!0}),collab.editor.collaborator.add(t,t.key),((o=collab.doc).collaborator||(o.collaborator={}))[t.key]?void 0:collab.doc.submitOp([{p:["collaborator",t.key],oi:(o={key:t.key,displayname:t.displayname,guest:t.guest},o.jointime=(new Date).getTime(),o)}])},exit:function(t){var o;if(collab.doc&&collab.doc.data)return((o=collab.doc.data).collaborator||(o.collaborator={}))[t.key]?(collab.editor.collaborator.remove(t,t.key),collab.doc.submitOp([{p:["collaborator",t.key],od:collab.doc.data.collaborator[t.key]}])):void 0}},init:function(t,o,e){var r,l,i,n,a=this;return r=[t,o],this.root=r[0],this.editor=r[1],this.root.innerHTML="",l=window.location.pathname,this.socket=new WebSocket(("http"===o.server.scheme?"ws":"wss")+"://"+o.server.domain+"/ws"),i=function(){return o.online.toggle(!1)},this.socket.readyState>=2?i():(this.socket.addEventListener("close",function(t){return 3001!==t.code?i():void 0}),this.socket.addEventListener("error",function(){return 1===a.socket.readyState?i():void 0}),this.connection=new sharedb.Connection(this.socket),this.pageid=/^\/page\//.exec(l)?l.replace(/^\/page\//,"").replace(/\/$/,""):null,this.doc=n=this.connection.get("doc",this.pageid),n.on("load",function(){var t,e,r,l,i,a;if(n.data){for(t=0,r=(e=n.data.child).length;r>t;++t)l=t,i=e[t],i&&(o.block.prepare(i.content,i.type,l,!1,i.style)||"");for(a in e=n.data.collaborator)i=e[a],o.collaborator.add(i,a)}return o.loading.toggle(!1)}),n.fetch(function(){var t;return n.type||(t=n.create({attr:{},style:{},child:[],collaborator:{}})),n.subscribe(function(t,o){return a.handle(t,o)}),n.on("op",function(t,o){return a.handle(t,o)}),collab.action.join(e)}))},handle:function(t,o){function e(t){return/inner/.exec(t.getAttribute("class"))}var r,l,i,n,a,c,d,s,u,h=[];if(t&&!o){for(r=0,l=t.length;l>r;++r)i=t[r],i.si||i.sd?(console.log(i.p),"style"===i.p[2]?(n=this.root.childNodes[i.p[1]],h.push(n.style=this.doc.data.child[i.p[1]].style||"")):"style"===i.p[0]?h.push(this.root.style=this.doc.data.style||""):"attr"===i.p[0]||"child"===i.p[0]&&"content"===i.p[2]&&4===i.p.length&&(n=this.root.childNodes[i.p[1]],a=Array.from(n.childNodes).filter(e)[0],a.innerHTML=this.doc.data.child[i.p[1]].content,h.push(this.editor.block.prepare(n,n.getAttribute("base-block"),i.p[1],!0)))):i.li?h.push(this.editor.block.prepare(i.li.content,i.li.type,i.p[1],i.li.style)):i.ld?(n=this.root.childNodes[i.p[1]],h.push(n.parentNode.removeChild(n))):null!=i.lm?(c=[i.p[1],i.lm],d=c[0],s=c[1],d!==s&&(n=this.root.childNodes[d],u=this.root.childNodes[s+(s>d?1:0)],this.root.removeChild(n),h.push(u?this.root.insertBefore(n,u):this.root.appendChild(n)))):i.oi?"collaborator"===i.p[0]&&h.push("cursor"===i.p[2]?this.editor.collaborator.update(this.doc.data.collaborator[i.p[1]],i.p[1]):this.editor.collaborator.add(i.oi,i.p[1])):i.od&&"collaborator"===i.p[0]&&h.push(this.editor.collaborator.remove(i.od,i.p[1]));return h}}},x$=angular.module("webedit"),x$.service("collaborate",["$rootScope"].concat(function(){return collab})),x$.controller("collabInfo",["$scope","$http"].concat(function(){var t;return t=document.querySelector("#collab-info"),t.style.left=1024+Math.round((window.innerWidth-1024)/2)+"px",t.style.right="auto"}));