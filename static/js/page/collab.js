function import$(t,o){var e={}.hasOwnProperty;for(var r in o)e.call(o,r)&&(t[r]=o[r]);return t}var collab,x$;collab={action:{info:function(t){var o,e,r,i,a,l;if(o=[t,collab.doc],e=o[0],r=o[1],!r||!r.data)return[];for(;e&&e.parentNode&&!e.getAttribute("base-block");)e=e.parentNode;return e&&e.getAttribute&&e.getAttribute("base-block")?(i=Array.from(e.parentNode.childNodes).indexOf(e),a=e.getAttribute("base-block"),l=e.getAttribute("eid"),[e,r,i,a,l]):[]},setPublic:function(t){var o,e;return o=collab.doc.data.attr,o&&o.isPublic!==t?collab.doc.submitOp([{p:["attr"],od:o,oi:(e=import$({},o),e.isPublic=t,e)}]):void 0},setThumbnail:function(t){var o,e;return null==t&&(t=null),t?(o=collab.doc,o.data.attr.thumbnail?(o.submitOp([{p:["attr","thumbnail",0],sd:o.data.attr.thumbnail}]),o.submitOp([{p:["attr","thumbnail",0],si:t}])):o.submitOp([{p:["attr"],od:o.data.attr,oi:(e=import$({},o.data.attr),e.thumbnail=t,e)}])):void 0},setTitle:function(t){return this.setTitle.handler&&(clearTimeout(this.setTitle.handler),this.setTitle.handler=null),this.setTitle.handler=setTimeout(function(){var o,e,r,i;return o=collab.doc,e=t,e||(r=Array.from(document.querySelector("#editor .inner").querySelectorAll("h1,h2,h3")),r.sort(function(t,o){return t.nodeName===o.nodeName?0:t.nodeName>o.nodeName?1:-1}),r[0]&&(e=r[0].innerText)),e||(e="untitled"),o.data.attr.title!==e?(e.length>60&&(e=e.substring(0,57)+"..."),o.data.attr.title?(o.submitOp([{p:["attr","title",0],sd:o.data.attr.title}]),o.submitOp([{p:["attr","title",0],si:e}])):o.submitOp([{p:["attr"],oi:(i=import$({},o.data.attr),i.title=e,i)}])):void 0},1e3)},moveBlock:function(t,o){return collab.doc.submitOp([{p:["child",t],lm:o}])},deleteBlock:function(t){var o,e,r,i,a;return o=this.info(t),e=o[0],r=o[1],i=o[2],a=o[3],e?r.submitOp([{p:["child",i],ld:r.data.child[i]}]):void 0},insertBlock:function(t){var o,e,r,i,a,l;return o=this.info(t),e=o[0],r=o[1],i=o[2],a=o[3],l=o[4],e?(r.submitOp([{p:["child",i],li:{content:this.blockContent(e),type:a,eid:l}}]),this.setTitle()):void 0},blockContent:function(t){var o;return o=Array.from(t.childNodes).filter(function(t){return/inner/.exec(t.getAttribute("class"))})[0],o.querySelector("[auto-content]")&&(o=o.cloneNode(!0),Array.from(o.querySelectorAll("[auto-content]")).map(function(t){return Array.from(t.childNodes).map(function(o){return t.removeChild(o)})})),puredom.sanitize((o||{}).innerHTML)},strDiff:function(t,o,e){var r,i,a,l,n,c,d,s=[];for(null==t&&(t=[]),null==o&&(o=""),null==e&&(e=""),r=[collab.doc,fastDiff(o,e),0],i=r[0],a=r[1],l=r[2],n=0,c=a.length;c>n;++n)d=a[n],0===d[0]?s.push(l+=d[1].length):1===d[0]?(i.submitOp([{p:t.concat([l]),si:d[1]}]),s.push(l+=d[1].length)):s.push(i.submitOp([{p:t.concat([l]),sd:d[1]}]));return s},editStyle:function(t,o){var e,r,i,a,l,n,c,d;if(null==o&&(o=!1),e=collab.doc,r=t.getAttribute("style"),o){if(r=r.replace(/width:\d+px;?/,""),i=[e.data,[]],a=i[0],l=i[1],!a.style)return e.submitOp([{p:l,od:a,oi:(i=import$({},a),i.style=r,i)}])}else{if(i=this.info(t),n=i[0],e=i[1],c=i[2],d=i[3],!n||!e.data.child[c])return;if(i=[e.data.child[c],["child",c]],a=i[0],l=i[1],!a.style)return e.submitOp([{p:l,ld:a,li:(i=import$({},a),i.style=r,i)}])}return this.strDiff(l.concat(["style"]),a.style,r)},editBlock:function(t){var o,e,r,i,a,l,n,c;return o=this.info(t),e=o[0],r=o[1],i=o[2],a=o[3],e?(l={last:(r.data.child[i]||{}).content||"",now:this.blockContent(e)},n=fastDiff(l.last,l.now),r.data.child[i]||r.submitOp([{p:["child",i],li:{content:"",type:a,style:""}}]),c=0,this.strDiff(["child",i,"content"],l.last,l.now),this.setTitle()):void 0},cursor:function(t,o){var e;if(t&&(t.key||t.guestkey)&&collab.doc&&collab.doc.data&&(e=t.key||t.guestkey,collab.doc.data.collaborator&&collab.doc.data.collaborator[e]))return collab.doc.submitOp([{p:["collaborator",e,"cursor"],od:collab.doc.data.collaborator[e].cursor,oi:o}])},join:function(t){var o,e,r;if(t&&collab.doc&&collab.doc.data&&collab.doc.data.collaborator&&(o=t.key||t.guestkey,o&&!((e=collab.doc.data).collaborator||(e.collaborator={}))[o]))return this.join.user=t,collab.editor.collaborator.add(t),collab.doc.submitOp([{p:["collaborator",o],oi:(r={},r.key=t.key,r.displayname=t.displayname,r.guestkey=t.guestkey,e=r,e.jointime=(new Date).getTime(),e)}])},exit:function(){var t;if(this.join.user&&(t=this.join.user.key||this.join.user.guestkey,t&&collab.doc&&collab.doc.data&&collab.doc.data.collaborator&&collab.doc.data.collaborator[t]))return collab.editor.collaborator.remove(t),collab.doc.submitOp([{p:["collaborator",t],od:collab.doc.data.collaborator[t]}])}},init:function(t,o){var e,r,i,a,l=this;return e=[t,o],this.root=e[0],this.editor=e[1],this.root.innerHTML="",r=window.location.pathname,this.socket=new WebSocket(("http"===o.server.scheme?"ws":"wss")+"://"+o.server.domain+"/ws"),i=function(){return o.online.toggle(!1)},this.socket.readyState>=2?i():(this.socket.addEventListener("close",function(t){return 3001!==t.code?i():void 0}),this.socket.addEventListener("error",function(){return 1===l.socket.readyState?i():void 0}),this.connection=new sharedb.Connection(this.socket),this.pageid=/^\/page\//.exec(r)?r.replace(/^\/page\//,"").replace(/\/$/,""):null,this.doc=a=this.connection.get("doc",this.pageid),a.on("load",function(){var t,e,r,i,l,n;if(a.data){for(t=0,r=(e=a.data.child).length;r>t;++t)i=t,l=e[t],l&&o.block.prepare(l.content,{name:l.type,idx:i,redo:!1,style:l.style||"",source:!1,eid:l.eid});o.block.init();for(n in e=a.data.collaborator)l=e[n],o.collaborator.add(l,n);o.page.prepare(a.data)}return o.loading.toggle(!1)}),a.fetch(function(t){var e;return t?o.online.toggle(!1,{code:403}):(a.type||(e=a.create({attr:{},style:{},child:[],collaborator:{}})),a.subscribe(function(t,o){return l.handle(t,o)}),a.on("op",function(t,o){return l.handle(t,o)}),o.user.data?collab.action.join(o.user.data):void 0)}))},handle:function(t,o){var e,r,i,a,l,n,c,d,s=[];if(t&&!o){for(e=0,r=t.length;r>e;++e)i=t[e],i.si||i.sd?"style"===i.p[2]?(a=this.root.childNodes[i.p[1]],s.push(a.style=this.doc.data.child[i.p[1]].style||"")):"style"===i.p[0]?s.push(this.root.style=this.doc.data.style||""):"attr"===i.p[0]||"child"===i.p[0]&&"content"===i.p[2]&&4===i.p.length&&(a=this.root.childNodes[i.p[1]],s.push(this.editor.block.prepareAsync(a,{name:a.getAttribute("base-block"),idx:i.p[1],redo:!0,content:this.doc.data.child[i.p[1]].content,source:!1}))):i.li?s.push(this.editor.block.prepare(i.li.content,{name:i.li.type,idx:i.p[1],redo:!1,style:i.li.style,source:!1,eid:i.li.eid})):i.ld?(a=this.root.childNodes[i.p[1]],s.push(a.parentNode.removeChild(a))):null!=i.lm?(l=[i.p[1],i.lm],n=l[0],c=l[1],n!==c&&(a=this.root.childNodes[n],d=this.root.childNodes[c+(c>n?1:0)],this.root.removeChild(a),s.push(d?this.root.insertBefore(a,d):this.root.appendChild(a)))):i.oi?"collaborator"===i.p[0]?s.push("cursor"===i.p[2]?this.editor.collaborator.update(this.doc.data.collaborator[i.p[1]],i.p[1]):this.editor.collaborator.add(i.oi,i.p[1])):"attr"===i.p[0]&&s.push(collab.editor.page.share.setPublic(this.doc.data.attr.isPublic)):i.od&&"collaborator"===i.p[0]&&s.push(this.editor.collaborator.remove(i.p[1]));return s}}},x$=angular.module("webedit"),x$.service("collaborate",["$rootScope"].concat(function(){return collab})),x$.controller("collabInfo",["$scope","$http"].concat(function(){var t;return t=document.querySelector("#collab-info"),t.style.left=1024+Math.round((window.innerWidth-1024)/2)+"px",t.style.right="auto"}));