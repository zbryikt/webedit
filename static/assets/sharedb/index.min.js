(function(){function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require=="function"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}var i=typeof require=="function"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s}return e})()({1:[function(require,module,exports){var DIFF_DELETE=-1;var DIFF_INSERT=1;var DIFF_EQUAL=0;function diff_main(text1,text2,cursor_pos){if(text1==text2){if(text1){return[[DIFF_EQUAL,text1]]}return[]}if(cursor_pos<0||text1.length<cursor_pos){cursor_pos=null}var commonlength=diff_commonPrefix(text1,text2);var commonprefix=text1.substring(0,commonlength);text1=text1.substring(commonlength);text2=text2.substring(commonlength);commonlength=diff_commonSuffix(text1,text2);var commonsuffix=text1.substring(text1.length-commonlength);text1=text1.substring(0,text1.length-commonlength);text2=text2.substring(0,text2.length-commonlength);var diffs=diff_compute_(text1,text2);if(commonprefix){diffs.unshift([DIFF_EQUAL,commonprefix])}if(commonsuffix){diffs.push([DIFF_EQUAL,commonsuffix])}diff_cleanupMerge(diffs);if(cursor_pos!=null){diffs=fix_cursor(diffs,cursor_pos)}diffs=fix_emoji(diffs);return diffs}function diff_compute_(text1,text2){var diffs;if(!text1){return[[DIFF_INSERT,text2]]}if(!text2){return[[DIFF_DELETE,text1]]}var longtext=text1.length>text2.length?text1:text2;var shorttext=text1.length>text2.length?text2:text1;var i=longtext.indexOf(shorttext);if(i!=-1){diffs=[[DIFF_INSERT,longtext.substring(0,i)],[DIFF_EQUAL,shorttext],[DIFF_INSERT,longtext.substring(i+shorttext.length)]];if(text1.length>text2.length){diffs[0][0]=diffs[2][0]=DIFF_DELETE}return diffs}if(shorttext.length==1){return[[DIFF_DELETE,text1],[DIFF_INSERT,text2]]}var hm=diff_halfMatch_(text1,text2);if(hm){var text1_a=hm[0];var text1_b=hm[1];var text2_a=hm[2];var text2_b=hm[3];var mid_common=hm[4];var diffs_a=diff_main(text1_a,text2_a);var diffs_b=diff_main(text1_b,text2_b);return diffs_a.concat([[DIFF_EQUAL,mid_common]],diffs_b)}return diff_bisect_(text1,text2)}function diff_bisect_(text1,text2){var text1_length=text1.length;var text2_length=text2.length;var max_d=Math.ceil((text1_length+text2_length)/2);var v_offset=max_d;var v_length=2*max_d;var v1=new Array(v_length);var v2=new Array(v_length);for(var x=0;x<v_length;x++){v1[x]=-1;v2[x]=-1}v1[v_offset+1]=0;v2[v_offset+1]=0;var delta=text1_length-text2_length;var front=delta%2!=0;var k1start=0;var k1end=0;var k2start=0;var k2end=0;for(var d=0;d<max_d;d++){for(var k1=-d+k1start;k1<=d-k1end;k1+=2){var k1_offset=v_offset+k1;var x1;if(k1==-d||k1!=d&&v1[k1_offset-1]<v1[k1_offset+1]){x1=v1[k1_offset+1]}else{x1=v1[k1_offset-1]+1}var y1=x1-k1;while(x1<text1_length&&y1<text2_length&&text1.charAt(x1)==text2.charAt(y1)){x1++;y1++}v1[k1_offset]=x1;if(x1>text1_length){k1end+=2}else if(y1>text2_length){k1start+=2}else if(front){var k2_offset=v_offset+delta-k1;if(k2_offset>=0&&k2_offset<v_length&&v2[k2_offset]!=-1){var x2=text1_length-v2[k2_offset];if(x1>=x2){return diff_bisectSplit_(text1,text2,x1,y1)}}}}for(var k2=-d+k2start;k2<=d-k2end;k2+=2){var k2_offset=v_offset+k2;var x2;if(k2==-d||k2!=d&&v2[k2_offset-1]<v2[k2_offset+1]){x2=v2[k2_offset+1]}else{x2=v2[k2_offset-1]+1}var y2=x2-k2;while(x2<text1_length&&y2<text2_length&&text1.charAt(text1_length-x2-1)==text2.charAt(text2_length-y2-1)){x2++;y2++}v2[k2_offset]=x2;if(x2>text1_length){k2end+=2}else if(y2>text2_length){k2start+=2}else if(!front){var k1_offset=v_offset+delta-k2;if(k1_offset>=0&&k1_offset<v_length&&v1[k1_offset]!=-1){var x1=v1[k1_offset];var y1=v_offset+x1-k1_offset;x2=text1_length-x2;if(x1>=x2){return diff_bisectSplit_(text1,text2,x1,y1)}}}}}return[[DIFF_DELETE,text1],[DIFF_INSERT,text2]]}function diff_bisectSplit_(text1,text2,x,y){var text1a=text1.substring(0,x);var text2a=text2.substring(0,y);var text1b=text1.substring(x);var text2b=text2.substring(y);var diffs=diff_main(text1a,text2a);var diffsb=diff_main(text1b,text2b);return diffs.concat(diffsb)}function diff_commonPrefix(text1,text2){if(!text1||!text2||text1.charAt(0)!=text2.charAt(0)){return 0}var pointermin=0;var pointermax=Math.min(text1.length,text2.length);var pointermid=pointermax;var pointerstart=0;while(pointermin<pointermid){if(text1.substring(pointerstart,pointermid)==text2.substring(pointerstart,pointermid)){pointermin=pointermid;pointerstart=pointermin}else{pointermax=pointermid}pointermid=Math.floor((pointermax-pointermin)/2+pointermin)}return pointermid}function diff_commonSuffix(text1,text2){if(!text1||!text2||text1.charAt(text1.length-1)!=text2.charAt(text2.length-1)){return 0}var pointermin=0;var pointermax=Math.min(text1.length,text2.length);var pointermid=pointermax;var pointerend=0;while(pointermin<pointermid){if(text1.substring(text1.length-pointermid,text1.length-pointerend)==text2.substring(text2.length-pointermid,text2.length-pointerend)){pointermin=pointermid;pointerend=pointermin}else{pointermax=pointermid}pointermid=Math.floor((pointermax-pointermin)/2+pointermin)}return pointermid}function diff_halfMatch_(text1,text2){var longtext=text1.length>text2.length?text1:text2;var shorttext=text1.length>text2.length?text2:text1;if(longtext.length<4||shorttext.length*2<longtext.length){return null}function diff_halfMatchI_(longtext,shorttext,i){var seed=longtext.substring(i,i+Math.floor(longtext.length/4));var j=-1;var best_common="";var best_longtext_a,best_longtext_b,best_shorttext_a,best_shorttext_b;while((j=shorttext.indexOf(seed,j+1))!=-1){var prefixLength=diff_commonPrefix(longtext.substring(i),shorttext.substring(j));var suffixLength=diff_commonSuffix(longtext.substring(0,i),shorttext.substring(0,j));if(best_common.length<suffixLength+prefixLength){best_common=shorttext.substring(j-suffixLength,j)+shorttext.substring(j,j+prefixLength);best_longtext_a=longtext.substring(0,i-suffixLength);best_longtext_b=longtext.substring(i+prefixLength);best_shorttext_a=shorttext.substring(0,j-suffixLength);best_shorttext_b=shorttext.substring(j+prefixLength)}}if(best_common.length*2>=longtext.length){return[best_longtext_a,best_longtext_b,best_shorttext_a,best_shorttext_b,best_common]}else{return null}}var hm1=diff_halfMatchI_(longtext,shorttext,Math.ceil(longtext.length/4));var hm2=diff_halfMatchI_(longtext,shorttext,Math.ceil(longtext.length/2));var hm;if(!hm1&&!hm2){return null}else if(!hm2){hm=hm1}else if(!hm1){hm=hm2}else{hm=hm1[4].length>hm2[4].length?hm1:hm2}var text1_a,text1_b,text2_a,text2_b;if(text1.length>text2.length){text1_a=hm[0];text1_b=hm[1];text2_a=hm[2];text2_b=hm[3]}else{text2_a=hm[0];text2_b=hm[1];text1_a=hm[2];text1_b=hm[3]}var mid_common=hm[4];return[text1_a,text1_b,text2_a,text2_b,mid_common]}function diff_cleanupMerge(diffs){diffs.push([DIFF_EQUAL,""]);var pointer=0;var count_delete=0;var count_insert=0;var text_delete="";var text_insert="";var commonlength;while(pointer<diffs.length){switch(diffs[pointer][0]){case DIFF_INSERT:count_insert++;text_insert+=diffs[pointer][1];pointer++;break;case DIFF_DELETE:count_delete++;text_delete+=diffs[pointer][1];pointer++;break;case DIFF_EQUAL:if(count_delete+count_insert>1){if(count_delete!==0&&count_insert!==0){commonlength=diff_commonPrefix(text_insert,text_delete);if(commonlength!==0){if(pointer-count_delete-count_insert>0&&diffs[pointer-count_delete-count_insert-1][0]==DIFF_EQUAL){diffs[pointer-count_delete-count_insert-1][1]+=text_insert.substring(0,commonlength)}else{diffs.splice(0,0,[DIFF_EQUAL,text_insert.substring(0,commonlength)]);pointer++}text_insert=text_insert.substring(commonlength);text_delete=text_delete.substring(commonlength)}commonlength=diff_commonSuffix(text_insert,text_delete);if(commonlength!==0){diffs[pointer][1]=text_insert.substring(text_insert.length-commonlength)+diffs[pointer][1];text_insert=text_insert.substring(0,text_insert.length-commonlength);text_delete=text_delete.substring(0,text_delete.length-commonlength)}}if(count_delete===0){diffs.splice(pointer-count_insert,count_delete+count_insert,[DIFF_INSERT,text_insert])}else if(count_insert===0){diffs.splice(pointer-count_delete,count_delete+count_insert,[DIFF_DELETE,text_delete])}else{diffs.splice(pointer-count_delete-count_insert,count_delete+count_insert,[DIFF_DELETE,text_delete],[DIFF_INSERT,text_insert])}pointer=pointer-count_delete-count_insert+(count_delete?1:0)+(count_insert?1:0)+1}else if(pointer!==0&&diffs[pointer-1][0]==DIFF_EQUAL){diffs[pointer-1][1]+=diffs[pointer][1];diffs.splice(pointer,1)}else{pointer++}count_insert=0;count_delete=0;text_delete="";text_insert="";break}}if(diffs[diffs.length-1][1]===""){diffs.pop()}var changes=false;pointer=1;while(pointer<diffs.length-1){if(diffs[pointer-1][0]==DIFF_EQUAL&&diffs[pointer+1][0]==DIFF_EQUAL){if(diffs[pointer][1].substring(diffs[pointer][1].length-diffs[pointer-1][1].length)==diffs[pointer-1][1]){diffs[pointer][1]=diffs[pointer-1][1]+diffs[pointer][1].substring(0,diffs[pointer][1].length-diffs[pointer-1][1].length);diffs[pointer+1][1]=diffs[pointer-1][1]+diffs[pointer+1][1];diffs.splice(pointer-1,1);changes=true}else if(diffs[pointer][1].substring(0,diffs[pointer+1][1].length)==diffs[pointer+1][1]){diffs[pointer-1][1]+=diffs[pointer+1][1];diffs[pointer][1]=diffs[pointer][1].substring(diffs[pointer+1][1].length)+diffs[pointer+1][1];diffs.splice(pointer+1,1);changes=true}}pointer++}if(changes){diff_cleanupMerge(diffs)}}var diff=diff_main;diff.INSERT=DIFF_INSERT;diff.DELETE=DIFF_DELETE;diff.EQUAL=DIFF_EQUAL;module.exports=diff;function cursor_normalize_diff(diffs,cursor_pos){if(cursor_pos===0){return[DIFF_EQUAL,diffs]}for(var current_pos=0,i=0;i<diffs.length;i++){var d=diffs[i];if(d[0]===DIFF_DELETE||d[0]===DIFF_EQUAL){var next_pos=current_pos+d[1].length;if(cursor_pos===next_pos){return[i+1,diffs]}else if(cursor_pos<next_pos){diffs=diffs.slice();var split_pos=cursor_pos-current_pos;var d_left=[d[0],d[1].slice(0,split_pos)];var d_right=[d[0],d[1].slice(split_pos)];diffs.splice(i,1,d_left,d_right);return[i+1,diffs]}else{current_pos=next_pos}}}throw new Error("cursor_pos is out of bounds!")}function fix_cursor(diffs,cursor_pos){var norm=cursor_normalize_diff(diffs,cursor_pos);var ndiffs=norm[1];var cursor_pointer=norm[0];var d=ndiffs[cursor_pointer];var d_next=ndiffs[cursor_pointer+1];if(d==null){return diffs}else if(d[0]!==DIFF_EQUAL){return diffs}else{if(d_next!=null&&d[1]+d_next[1]===d_next[1]+d[1]){ndiffs.splice(cursor_pointer,2,d_next,d);return merge_tuples(ndiffs,cursor_pointer,2)}else if(d_next!=null&&d_next[1].indexOf(d[1])===0){ndiffs.splice(cursor_pointer,2,[d_next[0],d[1]],[0,d[1]]);var suffix=d_next[1].slice(d[1].length);if(suffix.length>0){ndiffs.splice(cursor_pointer+2,0,[d_next[0],suffix])}return merge_tuples(ndiffs,cursor_pointer,3)}else{return diffs}}}function fix_emoji(diffs){var compact=false;var starts_with_pair_end=function(str){return str.charCodeAt(0)>=56320&&str.charCodeAt(0)<=57343};var ends_with_pair_start=function(str){return str.charCodeAt(str.length-1)>=55296&&str.charCodeAt(str.length-1)<=56319};for(var i=2;i<diffs.length;i+=1){if(diffs[i-2][0]===DIFF_EQUAL&&ends_with_pair_start(diffs[i-2][1])&&diffs[i-1][0]===DIFF_DELETE&&starts_with_pair_end(diffs[i-1][1])&&diffs[i][0]===DIFF_INSERT&&starts_with_pair_end(diffs[i][1])){compact=true;diffs[i-1][1]=diffs[i-2][1].slice(-1)+diffs[i-1][1];diffs[i][1]=diffs[i-2][1].slice(-1)+diffs[i][1];diffs[i-2][1]=diffs[i-2][1].slice(0,-1)}}if(!compact){return diffs}var fixed_diffs=[];for(var i=0;i<diffs.length;i+=1){if(diffs[i][1].length>0){fixed_diffs.push(diffs[i])}}return fixed_diffs}function merge_tuples(diffs,start,length){for(var i=start+length-1;i>=0&&i>=start-1;i--){if(i+1<diffs.length){var left_d=diffs[i];var right_d=diffs[i+1];if(left_d[0]===right_d[1]){diffs.splice(i,2,[left_d[0],left_d[1]+right_d[1]])}}}return diffs}},{}],2:[function(require,module,exports){"use strict";var construct=typeof Reflect!=="undefined"?Reflect.construct:undefined;var defineProperty=Object.defineProperty;var captureStackTrace=Error.captureStackTrace;if(captureStackTrace===undefined){captureStackTrace=function captureStackTrace(error){var container=new Error;defineProperty(error,"stack",{configurable:true,get:function getStack(){var stack=container.stack;defineProperty(this,"stack",{configurable:true,value:stack,writable:true});return stack},set:function setStack(stack){defineProperty(error,"stack",{configurable:true,value:stack,writable:true})}})}}function BaseError(message){if(message!==undefined){defineProperty(this,"message",{configurable:true,value:message,writable:true})}var cname=this.constructor.name;if(cname!==undefined&&cname!==this.name){defineProperty(this,"name",{configurable:true,value:cname,writable:true})}captureStackTrace(this,this.constructor)}BaseError.prototype=Object.create(Error.prototype,{constructor:{configurable:true,value:BaseError,writable:true}});var setFunctionName=function(){function setFunctionName(fn,name){return defineProperty(fn,"name",{configurable:true,value:name})}try{var f=function(){};setFunctionName(f,"foo");if(f.name==="foo"){return setFunctionName}}catch(_){}}();function makeError(constructor,super_){if(super_==null||super_===Error){super_=BaseError}else if(typeof super_!=="function"){throw new TypeError("super_ should be a function")}var name;if(typeof constructor==="string"){name=constructor;constructor=construct!==undefined?function(){return construct(super_,arguments,this.constructor)}:function(){super_.apply(this,arguments)};if(setFunctionName!==undefined){setFunctionName(constructor,name);name=undefined}}else if(typeof constructor!=="function"){throw new TypeError("constructor should be either a string or a function")}constructor.super_=constructor["super"]=super_;var properties={constructor:{configurable:true,value:constructor,writable:true}};if(name!==undefined){properties.name={configurable:true,value:name,writable:true}}constructor.prototype=Object.create(super_.prototype,properties);return constructor}exports=module.exports=makeError;exports.BaseError=BaseError},{}],3:[function(require,module,exports){module.exports=bootstrapTransform;function bootstrapTransform(type,transformComponent,checkValidOp,append){var transformComponentX=function(left,right,destLeft,destRight){transformComponent(destLeft,left,right,"left");transformComponent(destRight,right,left,"right")};var transformX=type.transformX=function(leftOp,rightOp){checkValidOp(leftOp);checkValidOp(rightOp);var newRightOp=[];for(var i=0;i<rightOp.length;i++){var rightComponent=rightOp[i];var newLeftOp=[];var k=0;while(k<leftOp.length){var nextC=[];transformComponentX(leftOp[k],rightComponent,newLeftOp,nextC);k++;if(nextC.length===1){rightComponent=nextC[0]}else if(nextC.length===0){for(var j=k;j<leftOp.length;j++){append(newLeftOp,leftOp[j])}rightComponent=null;break}else{var pair=transformX(leftOp.slice(k),nextC);for(var l=0;l<pair[0].length;l++){append(newLeftOp,pair[0][l])}for(var r=0;r<pair[1].length;r++){append(newRightOp,pair[1][r])}rightComponent=null;break}}if(rightComponent!=null){append(newRightOp,rightComponent)}leftOp=newLeftOp}return[leftOp,newRightOp]};type.transform=function(op,otherOp,type){if(!(type==="left"||type==="right"))throw new Error("type must be 'left' or 'right'");if(otherOp.length===0)return op;if(op.length===1&&otherOp.length===1)return transformComponent([],op[0],otherOp[0],type);if(type==="left")return transformX(op,otherOp)[0];else return transformX(otherOp,op)[1]}}},{}],4:[function(require,module,exports){module.exports={type:require("./json0")}},{"./json0":5}],5:[function(require,module,exports){var isArray=function(obj){return Object.prototype.toString.call(obj)=="[object Array]"};var isObject=function(obj){return!!obj&&obj.constructor===Object};var clone=function(o){return JSON.parse(JSON.stringify(o))};var json={name:"json0",uri:"http://sharejs.org/types/JSONv0"};var subtypes={};json.registerSubtype=function(subtype){subtypes[subtype.name]=subtype};json.create=function(data){return data===undefined?null:clone(data)};json.invertComponent=function(c){var c_={p:c.p};if(c.t&&subtypes[c.t]){c_.t=c.t;c_.o=subtypes[c.t].invert(c.o)}if(c.si!==void 0)c_.sd=c.si;if(c.sd!==void 0)c_.si=c.sd;if(c.oi!==void 0)c_.od=c.oi;if(c.od!==void 0)c_.oi=c.od;if(c.li!==void 0)c_.ld=c.li;if(c.ld!==void 0)c_.li=c.ld;if(c.na!==void 0)c_.na=-c.na;if(c.lm!==void 0){c_.lm=c.p[c.p.length-1];c_.p=c.p.slice(0,c.p.length-1).concat([c.lm])}return c_};json.invert=function(op){var op_=op.slice().reverse();var iop=[];for(var i=0;i<op_.length;i++){iop.push(json.invertComponent(op_[i]))}return iop};json.checkValidOp=function(op){for(var i=0;i<op.length;i++){if(!isArray(op[i].p))throw new Error("Missing path")}};json.checkList=function(elem){if(!isArray(elem))throw new Error("Referenced element not a list")};json.checkObj=function(elem){if(!isObject(elem)){throw new Error("Referenced element not an object (it was "+JSON.stringify(elem)+")")}};function convertFromText(c){c.t="text0";var o={p:c.p.pop()};if(c.si!=null)o.i=c.si;if(c.sd!=null)o.d=c.sd;c.o=[o]}function convertToText(c){c.p.push(c.o[0].p);if(c.o[0].i!=null)c.si=c.o[0].i;if(c.o[0].d!=null)c.sd=c.o[0].d;delete c.t;delete c.o}json.apply=function(snapshot,op){json.checkValidOp(op);op=clone(op);var container={data:snapshot};for(var i=0;i<op.length;i++){var c=op[i];if(c.si!=null||c.sd!=null)convertFromText(c);var parent=null;var parentKey=null;var elem=container;var key="data";for(var j=0;j<c.p.length;j++){var p=c.p[j];parent=elem;parentKey=key;elem=elem[key];key=p;if(parent==null)throw new Error("Path invalid")}if(c.t&&c.o!==void 0&&subtypes[c.t]){elem[key]=subtypes[c.t].apply(elem[key],c.o)}else if(c.na!==void 0){if(typeof elem[key]!="number")throw new Error("Referenced element not a number");elem[key]+=c.na}else if(c.li!==void 0&&c.ld!==void 0){json.checkList(elem);elem[key]=c.li}else if(c.li!==void 0){json.checkList(elem);elem.splice(key,0,c.li)}else if(c.ld!==void 0){json.checkList(elem);elem.splice(key,1)}else if(c.lm!==void 0){json.checkList(elem);if(c.lm!=key){var e=elem[key];elem.splice(key,1);elem.splice(c.lm,0,e)}}else if(c.oi!==void 0){json.checkObj(elem);elem[key]=c.oi}else if(c.od!==void 0){json.checkObj(elem);delete elem[key]}else{throw new Error("invalid / missing instruction in op")}}return container.data};json.shatter=function(op){var results=[];for(var i=0;i<op.length;i++){results.push([op[i]])}return results};json.incrementalApply=function(snapshot,op,_yield){for(var i=0;i<op.length;i++){var smallOp=[op[i]];snapshot=json.apply(snapshot,smallOp);_yield(smallOp,snapshot)}return snapshot};var pathMatches=json.pathMatches=function(p1,p2,ignoreLast){if(p1.length!=p2.length)return false;for(var i=0;i<p1.length;i++){if(p1[i]!==p2[i]&&(!ignoreLast||i!==p1.length-1))return false}return true};json.append=function(dest,c){c=clone(c);if(dest.length===0){dest.push(c);return}var last=dest[dest.length-1];if((c.si!=null||c.sd!=null)&&(last.si!=null||last.sd!=null)){convertFromText(c);convertFromText(last)}if(pathMatches(c.p,last.p)){if(c.t&&last.t&&c.t===last.t&&subtypes[c.t]){last.o=subtypes[c.t].compose(last.o,c.o);if(c.si!=null||c.sd!=null){var p=c.p;for(var i=0;i<last.o.length-1;i++){c.o=[last.o.pop()];c.p=p.slice();convertToText(c);dest.push(c)}convertToText(last)}}else if(last.na!=null&&c.na!=null){dest[dest.length-1]={p:last.p,na:last.na+c.na}}else if(last.li!==undefined&&c.li===undefined&&c.ld===last.li){if(last.ld!==undefined){delete last.li}else{dest.pop()}}else if(last.od!==undefined&&last.oi===undefined&&c.oi!==undefined&&c.od===undefined){last.oi=c.oi}else if(last.oi!==undefined&&c.od!==undefined){if(c.oi!==undefined){last.oi=c.oi}else if(last.od!==undefined){delete last.oi}else{dest.pop()}}else if(c.lm!==undefined&&c.p[c.p.length-1]===c.lm){}else{dest.push(c)}}else{if((c.si!=null||c.sd!=null)&&(last.si!=null||last.sd!=null)){convertToText(c);convertToText(last)}dest.push(c)}};json.compose=function(op1,op2){json.checkValidOp(op1);json.checkValidOp(op2);var newOp=clone(op1);for(var i=0;i<op2.length;i++){json.append(newOp,op2[i])}return newOp};json.normalize=function(op){var newOp=[];op=isArray(op)?op:[op];for(var i=0;i<op.length;i++){var c=op[i];if(c.p==null)c.p=[];json.append(newOp,c)}return newOp};json.commonLengthForOps=function(a,b){var alen=a.p.length;var blen=b.p.length;if(a.na!=null||a.t)alen++;if(b.na!=null||b.t)blen++;if(alen===0)return-1;if(blen===0)return null;alen--;blen--;for(var i=0;i<alen;i++){var p=a.p[i];if(i>=blen||p!==b.p[i])return null}return alen};json.canOpAffectPath=function(op,path){return json.commonLengthForOps({p:path},op)!=null};json.transformComponent=function(dest,c,otherC,type){c=clone(c);var common=json.commonLengthForOps(otherC,c);var common2=json.commonLengthForOps(c,otherC);var cplength=c.p.length;var otherCplength=otherC.p.length;if(c.na!=null||c.t)cplength++;if(otherC.na!=null||otherC.t)otherCplength++;if(common2!=null&&otherCplength>cplength&&c.p[common2]==otherC.p[common2]){if(c.ld!==void 0){var oc=clone(otherC);oc.p=oc.p.slice(cplength);c.ld=json.apply(clone(c.ld),[oc])}else if(c.od!==void 0){var oc=clone(otherC);oc.p=oc.p.slice(cplength);c.od=json.apply(clone(c.od),[oc])}}if(common!=null){var commonOperand=cplength==otherCplength;var oc=otherC;if((c.si!=null||c.sd!=null)&&(otherC.si!=null||otherC.sd!=null)){convertFromText(c);oc=clone(otherC);convertFromText(oc)}if(oc.t&&subtypes[oc.t]){if(c.t&&c.t===oc.t){var res=subtypes[c.t].transform(c.o,oc.o,type);if(c.si!=null||c.sd!=null){var p=c.p;for(var i=0;i<res.length;i++){c.o=[res[i]];c.p=p.slice();convertToText(c);json.append(dest,c)}}else if(!isArray(res)||res.length>0){c.o=res;json.append(dest,c)}return dest}}else if(otherC.na!==void 0){}else if(otherC.li!==void 0&&otherC.ld!==void 0){if(otherC.p[common]===c.p[common]){if(!commonOperand){return dest}else if(c.ld!==void 0){if(c.li!==void 0&&type==="left"){c.ld=clone(otherC.li)}else{return dest}}}}else if(otherC.li!==void 0){if(c.li!==void 0&&c.ld===undefined&&commonOperand&&c.p[common]===otherC.p[common]){if(type==="right")c.p[common]++}else if(otherC.p[common]<=c.p[common]){c.p[common]++}if(c.lm!==void 0){if(commonOperand){if(otherC.p[common]<=c.lm)c.lm++}}}else if(otherC.ld!==void 0){if(c.lm!==void 0){if(commonOperand){if(otherC.p[common]===c.p[common]){return dest}var p=otherC.p[common];var from=c.p[common];var to=c.lm;if(p<to||p===to&&from<to)c.lm--}}if(otherC.p[common]<c.p[common]){c.p[common]--}else if(otherC.p[common]===c.p[common]){if(otherCplength<cplength){return dest}else if(c.ld!==void 0){if(c.li!==void 0){delete c.ld}else{return dest}}}}else if(otherC.lm!==void 0){if(c.lm!==void 0&&cplength===otherCplength){var from=c.p[common];var to=c.lm;var otherFrom=otherC.p[common];var otherTo=otherC.lm;if(otherFrom!==otherTo){if(from===otherFrom){if(type==="left"){c.p[common]=otherTo;if(from===to)c.lm=otherTo}else{return dest}}else{if(from>otherFrom)c.p[common]--;if(from>otherTo)c.p[common]++;else if(from===otherTo){if(otherFrom>otherTo){c.p[common]++;if(from===to)c.lm++}}if(to>otherFrom){c.lm--}else if(to===otherFrom){if(to>from)c.lm--}if(to>otherTo){c.lm++}else if(to===otherTo){if(otherTo>otherFrom&&to>from||otherTo<otherFrom&&to<from){if(type==="right")c.lm++}else{if(to>from)c.lm++;else if(to===otherFrom)c.lm--}}}}}else if(c.li!==void 0&&c.ld===undefined&&commonOperand){var from=otherC.p[common];var to=otherC.lm;p=c.p[common];if(p>from)c.p[common]--;if(p>to)c.p[common]++}else{var from=otherC.p[common];var to=otherC.lm;p=c.p[common];if(p===from){c.p[common]=to}else{if(p>from)c.p[common]--;if(p>to)c.p[common]++;else if(p===to&&from>to)c.p[common]++}}}else if(otherC.oi!==void 0&&otherC.od!==void 0){if(c.p[common]===otherC.p[common]){if(c.oi!==void 0&&commonOperand){if(type==="right"){return dest}else{c.od=otherC.oi}}else{return dest}}}else if(otherC.oi!==void 0){if(c.oi!==void 0&&c.p[common]===otherC.p[common]){if(type==="left"){json.append(dest,{p:c.p,od:otherC.oi})}else{return dest}}}else if(otherC.od!==void 0){if(c.p[common]==otherC.p[common]){if(!commonOperand)return dest;if(c.oi!==void 0){delete c.od}else{return dest}}}}json.append(dest,c);return dest};require("./bootstrapTransform")(json,json.transformComponent,json.checkValidOp,json.append);var text=require("./text0");json.registerSubtype(text);module.exports=json},{"./bootstrapTransform":3,"./text0":6}],6:[function(require,module,exports){var text=module.exports={name:"text0",uri:"http://sharejs.org/types/textv0",create:function(initial){if(initial!=null&&typeof initial!=="string"){throw new Error("Initial data must be a string")}return initial||""}};var strInject=function(s1,pos,s2){return s1.slice(0,pos)+s2+s1.slice(pos)};var checkValidComponent=function(c){if(typeof c.p!=="number")throw new Error("component missing position field");if(typeof c.i==="string"===(typeof c.d==="string"))throw new Error("component needs an i or d field");if(c.p<0)throw new Error("position cannot be negative")};var checkValidOp=function(op){for(var i=0;i<op.length;i++){checkValidComponent(op[i])}};text.apply=function(snapshot,op){var deleted;checkValidOp(op);for(var i=0;i<op.length;i++){var component=op[i];if(component.i!=null){snapshot=strInject(snapshot,component.p,component.i)}else{deleted=snapshot.slice(component.p,component.p+component.d.length);if(component.d!==deleted)throw new Error("Delete component '"+component.d+"' does not match deleted text '"+deleted+"'");snapshot=snapshot.slice(0,component.p)+snapshot.slice(component.p+component.d.length)}}return snapshot};var append=text._append=function(newOp,c){if(c.i===""||c.d==="")return;if(newOp.length===0){newOp.push(c)}else{var last=newOp[newOp.length-1];if(last.i!=null&&c.i!=null&&last.p<=c.p&&c.p<=last.p+last.i.length){newOp[newOp.length-1]={i:strInject(last.i,c.p-last.p,c.i),p:last.p}}else if(last.d!=null&&c.d!=null&&c.p<=last.p&&last.p<=c.p+c.d.length){newOp[newOp.length-1]={d:strInject(c.d,last.p-c.p,last.d),p:c.p}}else{newOp.push(c)}}};text.compose=function(op1,op2){checkValidOp(op1);checkValidOp(op2);var newOp=op1.slice();for(var i=0;i<op2.length;i++){append(newOp,op2[i])}return newOp};text.normalize=function(op){var newOp=[];if(op.i!=null||op.p!=null)op=[op];for(var i=0;i<op.length;i++){var c=op[i];if(c.p==null)c.p=0;append(newOp,c)}return newOp};var transformPosition=function(pos,c,insertAfter){if(c.i!=null){if(c.p<pos||c.p===pos&&insertAfter){return pos+c.i.length}else{return pos}}else{if(pos<=c.p){return pos}else if(pos<=c.p+c.d.length){return c.p}else{return pos-c.d.length}}};text.transformCursor=function(position,op,side){var insertAfter=side==="right";for(var i=0;i<op.length;i++){position=transformPosition(position,op[i],insertAfter)}return position};var transformComponent=text._tc=function(dest,c,otherC,side){checkValidComponent(c);checkValidComponent(otherC);if(c.i!=null){append(dest,{i:c.i,p:transformPosition(c.p,otherC,side==="right")})}else{if(otherC.i!=null){var s=c.d;if(c.p<otherC.p){append(dest,{d:s.slice(0,otherC.p-c.p),p:c.p});s=s.slice(otherC.p-c.p)}if(s!=="")append(dest,{d:s,p:c.p+otherC.i.length})}else{if(c.p>=otherC.p+otherC.d.length)append(dest,{d:c.d,p:c.p-otherC.d.length});else if(c.p+c.d.length<=otherC.p)append(dest,c);else{var newC={d:"",p:c.p};if(c.p<otherC.p)newC.d=c.d.slice(0,otherC.p-c.p);if(c.p+c.d.length>otherC.p+otherC.d.length)newC.d+=c.d.slice(otherC.p+otherC.d.length-c.p);var intersectStart=Math.max(c.p,otherC.p);var intersectEnd=Math.min(c.p+c.d.length,otherC.p+otherC.d.length);var cIntersect=c.d.slice(intersectStart-c.p,intersectEnd-c.p);var otherIntersect=otherC.d.slice(intersectStart-otherC.p,intersectEnd-otherC.p);if(cIntersect!==otherIntersect)throw new Error("Delete ops delete different text in the same region of the document");if(newC.d!==""){newC.p=transformPosition(newC.p,otherC);append(dest,newC)}}}}return dest};var invertComponent=function(c){return c.i!=null?{d:c.i,p:c.p}:{i:c.d,p:c.p}};text.invert=function(op){op=op.slice().reverse();for(var i=0;i<op.length;i++){op[i]=invertComponent(op[i])}return op};require("./bootstrapTransform")(text,transformComponent,checkValidOp,append)},{"./bootstrapTransform":3}],7:[function(require,module,exports){(function(process){var Doc=require("./doc");var Query=require("./query");var emitter=require("../emitter");var ShareDBError=require("../error");var types=require("../types");var util=require("../util");module.exports=Connection;function Connection(socket){emitter.EventEmitter.call(this);this.collections={};this.nextQueryId=1;this.queries={};this.seq=1;this.id=null;this.agent=null;this.debug=false;this.bindToSocket(socket)}emitter.mixin(Connection);Connection.prototype.bindToSocket=function(socket){if(this.socket){this.socket.close();this.socket.onmessage=null;this.socket.onopen=null;this.socket.onerror=null;this.socket.onclose=null}this.socket=socket;this.state=socket.readyState===0||socket.readyState===1?"connecting":"disconnected";this.canSend=false;var connection=this;socket.onmessage=function(event){try{var data=typeof event.data==="string"?JSON.parse(event.data):event.data}catch(err){console.warn("Failed to parse message",event);return}if(connection.debug)console.log("RECV",JSON.stringify(data));var request={data:data};connection.emit("receive",request);if(!request.data)return;try{connection.handleMessage(request.data)}catch(err){process.nextTick(function(){connection.emit("error",err)})}};socket.onopen=function(){connection._setState("connecting")};socket.onerror=function(err){connection.emit("connection error",err)};socket.onclose=function(reason){if(reason==="closed"||reason==="Closed"){connection._setState("closed",reason)}else if(reason==="stopped"||reason==="Stopped by server"){connection._setState("stopped",reason)}else{connection._setState("disconnected",reason)}}};Connection.prototype.handleMessage=function(message){var err=null;if(message.error){err=new Error(message.error.message);err.code=message.error.code;err.data=message;delete message.error}switch(message.a){case"init":if(message.protocol!==1){err=new ShareDBError(4019,"Invalid protocol version");return this.emit("error",err)}if(types.map[message.type]!==types.defaultType){err=new ShareDBError(4020,"Invalid default type");return this.emit("error",err)}if(typeof message.id!=="string"){err=new ShareDBError(4021,"Invalid client id");return this.emit("error",err)}this.id=message.id;this._setState("connected");return;case"qf":var query=this.queries[message.id];if(query)query._handleFetch(err,message.data,message.extra);return;case"qs":var query=this.queries[message.id];if(query)query._handleSubscribe(err,message.data,message.extra);return;case"qu":return;case"q":var query=this.queries[message.id];if(!query)return;if(err)return query._handleError(err);if(message.diff)query._handleDiff(message.diff);if(message.hasOwnProperty("extra"))query._handleExtra(message.extra);return;case"bf":return this._handleBulkMessage(message,"_handleFetch");case"bs":return this._handleBulkMessage(message,"_handleSubscribe");case"bu":return this._handleBulkMessage(message,"_handleUnsubscribe");case"f":var doc=this.getExisting(message.c,message.d);if(doc)doc._handleFetch(err,message.data);return;case"s":var doc=this.getExisting(message.c,message.d);if(doc)doc._handleSubscribe(err,message.data);return;case"u":var doc=this.getExisting(message.c,message.d);if(doc)doc._handleUnsubscribe(err);return;case"op":var doc=this.getExisting(message.c,message.d);if(doc)doc._handleOp(err,message);return;default:console.warn("Ignoring unrecognized message",message)}};Connection.prototype._handleBulkMessage=function(message,method){if(message.data){for(var id in message.data){var doc=this.getExisting(message.c,id);if(doc)doc[method](message.error,message.data[id])}}else if(Array.isArray(message.b)){for(var i=0;i<message.b.length;i++){var id=message.b[i];var doc=this.getExisting(message.c,id);if(doc)doc[method](message.error)}}else if(message.b){for(var id in message.b){var doc=this.getExisting(message.c,id);if(doc)doc[method](message.error)}}else{console.error("Invalid bulk message",message)}};Connection.prototype._reset=function(){this.seq=1;this.id=null;this.agent=null};Connection.prototype._setState=function(newState,reason){if(this.state===newState)return;if(newState==="connecting"&&this.state!=="disconnected"&&this.state!=="stopped"&&this.state!=="closed"||newState==="connected"&&this.state!=="connecting"){var err=new ShareDBError(5007,"Cannot transition directly from "+this.state+" to "+newState);return this.emit("error",err)}this.state=newState;this.canSend=newState==="connected";if(newState==="disconnected"||newState==="stopped"||newState==="closed")this._reset();this.startBulk();for(var id in this.queries){var query=this.queries[id];query._onConnectionStateChanged()}for(var collection in this.collections){var docs=this.collections[collection];for(var id in docs){docs[id]._onConnectionStateChanged()}}this.endBulk();this.emit(newState,reason);this.emit("state",newState,reason)};Connection.prototype.startBulk=function(){if(!this.bulk)this.bulk={}};Connection.prototype.endBulk=function(){if(this.bulk){for(var collection in this.bulk){var actions=this.bulk[collection];this._sendBulk("f",collection,actions.f);this._sendBulk("s",collection,actions.s);this._sendBulk("u",collection,actions.u)}}this.bulk=null};Connection.prototype._sendBulk=function(action,collection,values){if(!values)return;var ids=[];var versions={};var versionsCount=0;var versionId;for(var id in values){var value=values[id];if(value==null){ids.push(id)}else{versions[id]=value;versionId=id;versionsCount++}}if(ids.length===1){var id=ids[0];this.send({a:action,c:collection,d:id})}else if(ids.length){this.send({a:"b"+action,c:collection,b:ids})}if(versionsCount===1){var version=versions[versionId];this.send({a:action,c:collection,d:versionId,v:version})}else if(versionsCount){this.send({a:"b"+action,c:collection,b:versions})}};Connection.prototype._sendAction=function(action,doc,version){this._addDoc(doc);if(this.bulk){var actions=this.bulk[doc.collection]||(this.bulk[doc.collection]={});var versions=actions[action]||(actions[action]={});var isDuplicate=versions.hasOwnProperty(doc.id);versions[doc.id]=version;return isDuplicate}else{var message={a:action,c:doc.collection,d:doc.id,v:version};this.send(message)}};Connection.prototype.sendFetch=function(doc){return this._sendAction("f",doc,doc.version)};Connection.prototype.sendSubscribe=function(doc){return this._sendAction("s",doc,doc.version)};Connection.prototype.sendUnsubscribe=function(doc){return this._sendAction("u",doc)};Connection.prototype.sendOp=function(doc,op){this._addDoc(doc);var message={a:"op",c:doc.collection,d:doc.id,v:doc.version,src:op.src,seq:op.seq};if(op.op)message.op=op.op;if(op.create)message.create=op.create;if(op.del)message.del=op.del;this.send(message)};Connection.prototype.send=function(message){if(this.debug)console.log("SEND",JSON.stringify(message));this.emit("send",message);this.socket.send(JSON.stringify(message))};Connection.prototype.close=function(){this.socket.close()};Connection.prototype.getExisting=function(collection,id){if(this.collections[collection])return this.collections[collection][id]};Connection.prototype.get=function(collection,id){var docs=this.collections[collection]||(this.collections[collection]={});var doc=docs[id];if(!doc){doc=docs[id]=new Doc(this,collection,id);this.emit("doc",doc)}return doc};Connection.prototype._destroyDoc=function(doc){var docs=this.collections[doc.collection];if(!docs)return;delete docs[doc.id];if(!util.hasKeys(docs)){delete this.collections[doc.collection]}};Connection.prototype._addDoc=function(doc){var docs=this.collections[doc.collection];if(!docs){docs=this.collections[doc.collection]={}}if(docs[doc.id]!==doc){docs[doc.id]=doc}};Connection.prototype._createQuery=function(action,collection,q,options,callback){var id=this.nextQueryId++;var query=new Query(action,this,id,collection,q,options,callback);this.queries[id]=query;query.send();return query};Connection.prototype._destroyQuery=function(query){delete this.queries[query.id]};Connection.prototype.createFetchQuery=function(collection,q,options,callback){return this._createQuery("qf",collection,q,options,callback)};Connection.prototype.createSubscribeQuery=function(collection,q,options,callback){return this._createQuery("qs",collection,q,options,callback)};Connection.prototype.hasPending=function(){return!!(this._firstDoc(hasPending)||this._firstQuery(hasPending))};function hasPending(object){return object.hasPending()}Connection.prototype.hasWritePending=function(){return!!this._firstDoc(hasWritePending)};function hasWritePending(object){return object.hasWritePending()}Connection.prototype.whenNothingPending=function(callback){var doc=this._firstDoc(hasPending);if(doc){doc.once("nothing pending",this._nothingPendingRetry(callback));return}var query=this._firstQuery(hasPending);if(query){query.once("ready",this._nothingPendingRetry(callback));return}process.nextTick(callback)};Connection.prototype._nothingPendingRetry=function(callback){var connection=this;return function(){process.nextTick(function(){connection.whenNothingPending(callback)})}};Connection.prototype._firstDoc=function(fn){for(var collection in this.collections){var docs=this.collections[collection];for(var id in docs){var doc=docs[id];if(fn(doc)){return doc}}}};Connection.prototype._firstQuery=function(fn){for(var id in this.queries){var query=this.queries[id];if(fn(query)){return query}}}}).call(this,require("_process"))},{"../emitter":11,"../error":12,"../types":13,"../util":14,"./doc":8,"./query":10,_process:17}],8:[function(require,module,exports){(function(process){var emitter=require("../emitter");var ShareDBError=require("../error");var types=require("../types");module.exports=Doc;function Doc(connection,collection,id){emitter.EventEmitter.call(this);this.connection=connection;this.collection=collection;this.id=id;this.version=null;this.type=null;this.data=undefined;this.inflightFetch=[];this.inflightSubscribe=[];this.inflightUnsubscribe=[];this.pendingFetch=[];this.subscribed=false;this.wantSubscribe=false;this.inflightOp=null;this.pendingOps=[];this.type=null;this.applyStack=null;this.preventCompose=false}emitter.mixin(Doc);Doc.prototype.destroy=function(callback){var doc=this;doc.whenNothingPending(function(){doc.connection._destroyDoc(doc);if(doc.wantSubscribe){return doc.unsubscribe(callback)}if(callback)callback()})};Doc.prototype._setType=function(newType){if(typeof newType==="string"){newType=types.map[newType]}if(newType){this.type=newType}else if(newType===null){this.type=newType;this.data=undefined}else{var err=new ShareDBError(4008,"Missing type "+newType);return this.emit("error",err)}};Doc.prototype.ingestSnapshot=function(snapshot,callback){if(!snapshot)return callback&&callback();if(typeof snapshot.v!=="number"){var err=new ShareDBError(5008,"Missing version in ingested snapshot. "+this.collection+"."+this.id);if(callback)return callback(err);return this.emit("error",err)}if(this.type||this.hasWritePending()){if(this.version==null){if(this.hasWritePending()){return callback&&this.once("no write pending",callback)}var err=new ShareDBError(5009,"Cannot ingest snapshot in doc with null version. "+this.collection+"."+this.id);if(callback)return callback(err);return this.emit("error",err)}if(snapshot.v>this.version)return this.fetch(callback);return callback&&callback()}if(this.version>snapshot.v)return callback&&callback();this.version=snapshot.v;var type=snapshot.type===undefined?types.defaultType:snapshot.type;this._setType(type);this.data=this.type&&this.type.deserialize?this.type.deserialize(snapshot.data):snapshot.data;this.emit("load");callback&&callback()};Doc.prototype.whenNothingPending=function(callback){if(this.hasPending()){this.once("nothing pending",callback);return}callback()};Doc.prototype.hasPending=function(){return!!(this.inflightOp||this.pendingOps.length||this.inflightFetch.length||this.inflightSubscribe.length||this.inflightUnsubscribe.length||this.pendingFetch.length)};Doc.prototype.hasWritePending=function(){return!!(this.inflightOp||this.pendingOps.length)};Doc.prototype._emitNothingPending=function(){if(this.hasWritePending())return;this.emit("no write pending");if(this.hasPending())return;this.emit("nothing pending")};Doc.prototype._emitResponseError=function(err,callback){if(callback){callback(err);this._emitNothingPending();return}this._emitNothingPending();this.emit("error",err)};Doc.prototype._handleFetch=function(err,snapshot){var callback=this.inflightFetch.shift();if(err)return this._emitResponseError(err,callback);this.ingestSnapshot(snapshot,callback);this._emitNothingPending()};Doc.prototype._handleSubscribe=function(err,snapshot){var callback=this.inflightSubscribe.shift();if(err)return this._emitResponseError(err,callback);if(this.wantSubscribe)this.subscribed=true;this.ingestSnapshot(snapshot,callback);this._emitNothingPending()};Doc.prototype._handleUnsubscribe=function(err){var callback=this.inflightUnsubscribe.shift();if(err)return this._emitResponseError(err,callback);if(callback)callback();this._emitNothingPending()};Doc.prototype._handleOp=function(err,message){if(err){if(this.inflightOp){if(err.code===4002)err=null;return this._rollback(err)}return this.emit("error",err)}if(this.inflightOp&&message.src===this.inflightOp.src&&message.seq===this.inflightOp.seq){this._opAcknowledged(message);return}if(this.version==null||message.v>this.version){this.fetch();return}if(message.v<this.version){return}if(this.inflightOp){var transformErr=transformX(this.inflightOp,message);if(transformErr)return this._hardRollback(transformErr)}for(var i=0;i<this.pendingOps.length;i++){var transformErr=transformX(this.pendingOps[i],message);if(transformErr)return this._hardRollback(transformErr)}this.version++;this._otApply(message,false);return};Doc.prototype._onConnectionStateChanged=function(){if(this.connection.canSend){this.flush();this._resubscribe()}else{if(this.inflightOp){this.pendingOps.unshift(this.inflightOp);this.inflightOp=null}this.subscribed=false;if(this.inflightFetch.length||this.inflightSubscribe.length){this.pendingFetch=this.pendingFetch.concat(this.inflightFetch,this.inflightSubscribe);this.inflightFetch.length=0;this.inflightSubscribe.length=0}if(this.inflightUnsubscribe.length){var callbacks=this.inflightUnsubscribe;this.inflightUnsubscribe=[];callEach(callbacks)}}};Doc.prototype._resubscribe=function(){var callbacks=this.pendingFetch;this.pendingFetch=[];if(this.wantSubscribe){if(callbacks.length){this.subscribe(function(err){callEach(callbacks,err)});return}this.subscribe();return}if(callbacks.length){this.fetch(function(err){callEach(callbacks,err)})}};Doc.prototype.fetch=function(callback){if(this.connection.canSend){var isDuplicate=this.connection.sendFetch(this);pushActionCallback(this.inflightFetch,isDuplicate,callback);return}this.pendingFetch.push(callback)};Doc.prototype.subscribe=function(callback){this.wantSubscribe=true;if(this.connection.canSend){var isDuplicate=this.connection.sendSubscribe(this);pushActionCallback(this.inflightSubscribe,isDuplicate,callback);return}this.pendingFetch.push(callback)};Doc.prototype.unsubscribe=function(callback){this.wantSubscribe=false;this.subscribed=false;if(this.connection.canSend){var isDuplicate=this.connection.sendUnsubscribe(this);pushActionCallback(this.inflightUnsubscribe,isDuplicate,callback);return}if(callback)process.nextTick(callback)};function pushActionCallback(inflight,isDuplicate,callback){if(isDuplicate){var lastCallback=inflight.pop();inflight.push(function(err){lastCallback&&lastCallback(err);callback&&callback(err)})}else{inflight.push(callback)}}Doc.prototype.flush=function(){if(!this.connection.canSend||this.inflightOp)return;if(!this.paused&&this.pendingOps.length){this._sendOp()}};function setNoOp(op){delete op.op;delete op.create;delete op.del}function transformX(client,server){if(client.del)return setNoOp(server);if(server.del){return new ShareDBError(4017,"Document was deleted")}if(server.create){return new ShareDBError(4018,"Document alredy created")}if(!server.op)return;if(client.create){return new ShareDBError(4018,"Document already created")}if(client.type.transformX){var result=client.type.transformX(client.op,server.op);client.op=result[0];server.op=result[1]}else{var clientOp=client.type.transform(client.op,server.op,"left");var serverOp=client.type.transform(server.op,client.op,"right");client.op=clientOp;server.op=serverOp}}Doc.prototype._otApply=function(op,source){if(op.op){if(!this.type){var err=new ShareDBError(4015,"Cannot apply op to uncreated document. "+this.collection+"."+this.id);return this.emit("error",err)}if(!source&&this.type===types.defaultType&&op.op.length>1){if(!this.applyStack)this.applyStack=[];var stackLength=this.applyStack.length;for(var i=0;i<op.op.length;i++){var component=op.op[i];var componentOp={op:[component]};for(var j=stackLength;j<this.applyStack.length;j++){var transformErr=transformX(this.applyStack[j],componentOp);if(transformErr)return this._hardRollback(transformErr)}this.emit("before op",componentOp.op,source);this.data=this.type.apply(this.data,componentOp.op);this.emit("op",componentOp.op,source)}this._popApplyStack(stackLength);return}this.emit("before op",op.op,source);this.data=this.type.apply(this.data,op.op);this.emit("op",op.op,source);return}if(op.create){this._setType(op.create.type);this.data=this.type.deserialize?this.type.createDeserialized?this.type.createDeserialized(op.create.data):this.type.deserialize(this.type.create(op.create.data)):this.type.create(op.create.data);this.emit("create",source);return}if(op.del){var oldData=this.data;this._setType(null);this.emit("del",oldData,source);return}};Doc.prototype._sendOp=function(){var src=this.connection.id;if(!src)return;if(!this.inflightOp){this.inflightOp=this.pendingOps.shift()}var op=this.inflightOp;if(!op){var err=new ShareDBError(5010,"No op to send on call to _sendOp");return this.emit("error",err)}op.sentAt=Date.now();op.retries=op.retries==null?0:op.retries+1;if(op.seq==null)op.seq=this.connection.seq++;this.connection.sendOp(this,op);if(op.src==null)op.src=src};Doc.prototype._submit=function(op,source,callback){if(!source)source=true;if(op.op){if(!this.type){var err=new ShareDBError(4015,"Cannot submit op. Document has not been created. "+this.collection+"."+this.id);if(callback)return callback(err);return this.emit("error",err)}if(this.type.normalize)op.op=this.type.normalize(op.op)}this._pushOp(op,callback);this._otApply(op,source);var doc=this;process.nextTick(function(){doc.flush()})};Doc.prototype._pushOp=function(op,callback){if(this.applyStack){this.applyStack.push(op)}else{var composed=this._tryCompose(op);if(composed){composed.callbacks.push(callback);return}}op.type=this.type;op.callbacks=[callback];this.pendingOps.push(op)};Doc.prototype._popApplyStack=function(to){if(to>0){this.applyStack.length=to;return}var op=this.applyStack[0];this.applyStack=null;if(!op)return;var i=this.pendingOps.indexOf(op);if(i===-1)return;var ops=this.pendingOps.splice(i);for(var i=0;i<ops.length;i++){var op=ops[i];var composed=this._tryCompose(op);if(composed){composed.callbacks=composed.callbacks.concat(op.callbacks)}else{this.pendingOps.push(op)}}};Doc.prototype._tryCompose=function(op){if(this.preventCompose)return;var last=this.pendingOps[this.pendingOps.length-1];if(!last)return;if(last.create&&op.op){last.create.data=this.type.apply(last.create.data,op.op);return last}if(last.op&&op.op&&this.type.compose){last.op=this.type.compose(last.op,op.op);return last}};Doc.prototype.submitOp=function(component,options,callback){if(typeof options==="function"){callback=options;options=null}var op={op:component};var source=options&&options.source;this._submit(op,source,callback)};Doc.prototype.create=function(data,type,options,callback){if(typeof type==="function"){callback=type;options=null;type=null}else if(typeof options==="function"){callback=options;options=null}if(!type){type=types.defaultType.uri}if(this.type){var err=new ShareDBError(4016,"Document already exists");if(callback)return callback(err);return this.emit("error",err)}var op={create:{type:type,data:data}};var source=options&&options.source;this._submit(op,source,callback)};Doc.prototype.del=function(options,callback){if(typeof options==="function"){callback=options;options=null}if(!this.type){var err=new ShareDBError(4015,"Document does not exist");if(callback)return callback(err);return this.emit("error",err)}var op={del:true};var source=options&&options.source;this._submit(op,source,callback)};Doc.prototype.pause=function(){this.paused=true};Doc.prototype.resume=function(){this.paused=false;this.flush()};Doc.prototype._opAcknowledged=function(message){if(this.inflightOp.create){this.version=message.v}else if(message.v!==this.version){console.warn("Invalid version from server. Expected: "+this.version+" Received: "+message.v,message);return this.fetch()}this.version++;this._clearInflightOp()};Doc.prototype._rollback=function(err){var op=this.inflightOp;if(op.op&&op.type.invert){op.op=op.type.invert(op.op);for(var i=0;i<this.pendingOps.length;i++){var transformErr=transformX(this.pendingOps[i],op);if(transformErr)return this._hardRollback(transformErr)}this._otApply(op,false);this._clearInflightOp(err);return}this._hardRollback(err)};Doc.prototype._hardRollback=function(err){var op=this.inflightOp;var pending=this.pendingOps;this._setType(null);this.version=null;this.inflightOp=null;this.pendingOps=[];var doc=this;this.fetch(function(){var called=op&&callEach(op.callbacks,err);for(var i=0;i<pending.length;i++){callEach(pending[i].callbacks,err)}if(err&&!called)return doc.emit("error",err)})};Doc.prototype._clearInflightOp=function(err){var called=callEach(this.inflightOp.callbacks,err);this.inflightOp=null;this.flush();this._emitNothingPending();if(err&&!called)return this.emit("error",err)};function callEach(callbacks,err){var called=false;for(var i=0;i<callbacks.length;i++){var callback=callbacks[i];if(callback){callback(err);called=true}}return called}}).call(this,require("_process"))},{"../emitter":11,"../error":12,"../types":13,_process:17}],9:[function(require,module,exports){exports.Connection=require("./connection");exports.Doc=require("./doc");exports.Error=require("../error");exports.Query=require("./query");exports.types=require("../types")},{"../error":12,"../types":13,"./connection":7,"./doc":8,"./query":10}],10:[function(require,module,exports){(function(process){var emitter=require("../emitter");module.exports=Query;function Query(action,connection,id,collection,query,options,callback){emitter.EventEmitter.call(this);this.action=action;this.connection=connection;this.id=id;this.collection=collection;this.query=query;this.results=null;if(options&&options.results){this.results=options.results;delete options.results}this.extra=undefined;this.options=options;this.callback=callback;this.ready=false;this.sent=false}emitter.mixin(Query);Query.prototype.hasPending=function(){return!this.ready};Query.prototype.send=function(){if(!this.connection.canSend)return;var message={a:this.action,id:this.id,c:this.collection,q:this.query};if(this.options){message.o=this.options}if(this.results){var results=[];for(var i=0;i<this.results.length;i++){var doc=this.results[i];results.push([doc.id,doc.version])}message.r=results}this.connection.send(message);this.sent=true};Query.prototype.destroy=function(callback){if(this.connection.canSend&&this.action==="qs"){this.connection.send({a:"qu",id:this.id})}this.connection._destroyQuery(this);if(callback)process.nextTick(callback)};Query.prototype._onConnectionStateChanged=function(){if(this.connection.canSend&&!this.sent){this.send()}else{this.sent=false}};Query.prototype._handleFetch=function(err,data,extra){this.connection._destroyQuery(this);this._handleResponse(err,data,extra)};Query.prototype._handleSubscribe=function(err,data,extra){this._handleResponse(err,data,extra)};Query.prototype._handleResponse=function(err,data,extra){var callback=this.callback;this.callback=null;if(err)return this._finishResponse(err,callback);if(!data)return this._finishResponse(null,callback);var query=this;var wait=1;var finish=function(err){if(err)return query._finishResponse(err,callback);if(--wait)return;query._finishResponse(null,callback)};if(Array.isArray(data)){wait+=data.length;this.results=this._ingestSnapshots(data,finish);this.extra=extra}else{for(var id in data){wait++;var snapshot=data[id];var doc=this.connection.get(snapshot.c||this.collection,id);doc.ingestSnapshot(snapshot,finish)}}finish()};Query.prototype._ingestSnapshots=function(snapshots,finish){var results=[];for(var i=0;i<snapshots.length;i++){var snapshot=snapshots[i];var doc=this.connection.get(snapshot.c||this.collection,snapshot.d);doc.ingestSnapshot(snapshot,finish);results.push(doc)}return results};Query.prototype._finishResponse=function(err,callback){this.emit("ready");this.ready=true;if(err){this.connection._destroyQuery(this);if(callback)return callback(err);return this.emit("error",err)}if(callback)callback(null,this.results,this.extra)};Query.prototype._handleError=function(err){this.emit("error",err)};Query.prototype._handleDiff=function(diff){for(var i=0;i<diff.length;i++){var d=diff[i];if(d.type==="insert")d.values=this._ingestSnapshots(d.values)}for(var i=0;i<diff.length;i++){var d=diff[i];switch(d.type){case"insert":var newDocs=d.values;Array.prototype.splice.apply(this.results,[d.index,0].concat(newDocs));this.emit("insert",newDocs,d.index);break;case"remove":var howMany=d.howMany||1;var removed=this.results.splice(d.index,howMany);this.emit("remove",removed,d.index);break;case"move":var howMany=d.howMany||1;var docs=this.results.splice(d.from,howMany);Array.prototype.splice.apply(this.results,[d.to,0].concat(docs));this.emit("move",docs,d.from,d.to);break}}this.emit("changed",this.results)};Query.prototype._handleExtra=function(extra){this.extra=extra;this.emit("extra",extra)}}).call(this,require("_process"))},{"../emitter":11,_process:17}],11:[function(require,module,exports){var EventEmitter=require("events").EventEmitter;exports.EventEmitter=EventEmitter;exports.mixin=mixin;function mixin(Constructor){for(var key in EventEmitter.prototype){Constructor.prototype[key]=EventEmitter.prototype[key]}}},{events:16}],12:[function(require,module,exports){var makeError=require("make-error");function ShareDBError(code,message){ShareDBError.super.call(this,message);this.code=code}makeError(ShareDBError);module.exports=ShareDBError},{"make-error":2}],13:[function(require,module,exports){exports.defaultType=require("ot-json0").type;exports.map={};exports.register=function(type){if(type.name)exports.map[type.name]=type;if(type.uri)exports.map[type.uri]=type};exports.register(exports.defaultType)},{"ot-json0":4}],14:[function(require,module,exports){exports.doNothing=doNothing;function doNothing(){}exports.hasKeys=function(object){for(var key in object)return true;return false}},{}],15:[function(require,module,exports){(function(global){global.sharedb=require("sharedb/lib/client");global.fastDiff=require("fast-diff")}).call(this,typeof global!=="undefined"?global:typeof self!=="undefined"?self:typeof window!=="undefined"?window:{})},{"fast-diff":1,"sharedb/lib/client":9}],16:[function(require,module,exports){var objectCreate=Object.create||objectCreatePolyfill;var objectKeys=Object.keys||objectKeysPolyfill;var bind=Function.prototype.bind||functionBindPolyfill;function EventEmitter(){if(!this._events||!Object.prototype.hasOwnProperty.call(this,"_events")){this._events=objectCreate(null);this._eventsCount=0}this._maxListeners=this._maxListeners||undefined}module.exports=EventEmitter;EventEmitter.EventEmitter=EventEmitter;EventEmitter.prototype._events=undefined;EventEmitter.prototype._maxListeners=undefined;var defaultMaxListeners=10;var hasDefineProperty;try{var o={};if(Object.defineProperty)Object.defineProperty(o,"x",{value:0});hasDefineProperty=o.x===0}catch(err){hasDefineProperty=false}if(hasDefineProperty){Object.defineProperty(EventEmitter,"defaultMaxListeners",{enumerable:true,get:function(){return defaultMaxListeners},set:function(arg){if(typeof arg!=="number"||arg<0||arg!==arg)throw new TypeError('"defaultMaxListeners" must be a positive number');defaultMaxListeners=arg}})}else{EventEmitter.defaultMaxListeners=defaultMaxListeners}EventEmitter.prototype.setMaxListeners=function setMaxListeners(n){if(typeof n!=="number"||n<0||isNaN(n))throw new TypeError('"n" argument must be a positive number');this._maxListeners=n;return this};function $getMaxListeners(that){if(that._maxListeners===undefined)return EventEmitter.defaultMaxListeners;return that._maxListeners}EventEmitter.prototype.getMaxListeners=function getMaxListeners(){return $getMaxListeners(this)};function emitNone(handler,isFn,self){if(isFn)handler.call(self);else{var len=handler.length;var listeners=arrayClone(handler,len);for(var i=0;i<len;++i)listeners[i].call(self)}}function emitOne(handler,isFn,self,arg1){if(isFn)handler.call(self,arg1);else{var len=handler.length;var listeners=arrayClone(handler,len);for(var i=0;i<len;++i)listeners[i].call(self,arg1)}}function emitTwo(handler,isFn,self,arg1,arg2){if(isFn)handler.call(self,arg1,arg2);else{var len=handler.length;var listeners=arrayClone(handler,len);for(var i=0;i<len;++i)listeners[i].call(self,arg1,arg2)}}function emitThree(handler,isFn,self,arg1,arg2,arg3){if(isFn)handler.call(self,arg1,arg2,arg3);else{var len=handler.length;var listeners=arrayClone(handler,len);for(var i=0;i<len;++i)listeners[i].call(self,arg1,arg2,arg3)}}function emitMany(handler,isFn,self,args){if(isFn)handler.apply(self,args);else{var len=handler.length;var listeners=arrayClone(handler,len);for(var i=0;i<len;++i)listeners[i].apply(self,args)}}EventEmitter.prototype.emit=function emit(type){var er,handler,len,args,i,events;var doError=type==="error";events=this._events;if(events)doError=doError&&events.error==null;else if(!doError)return false;if(doError){if(arguments.length>1)er=arguments[1];if(er instanceof Error){throw er}else{var err=new Error('Unhandled "error" event. ('+er+")");err.context=er;throw err}return false}handler=events[type];if(!handler)return false;var isFn=typeof handler==="function";len=arguments.length;switch(len){case 1:emitNone(handler,isFn,this);break;case 2:emitOne(handler,isFn,this,arguments[1]);break;case 3:emitTwo(handler,isFn,this,arguments[1],arguments[2]);break;case 4:emitThree(handler,isFn,this,arguments[1],arguments[2],arguments[3]);break;default:args=new Array(len-1);for(i=1;i<len;i++)args[i-1]=arguments[i];emitMany(handler,isFn,this,args)}return true};function _addListener(target,type,listener,prepend){var m;var events;var existing;if(typeof listener!=="function")throw new TypeError('"listener" argument must be a function');events=target._events;if(!events){events=target._events=objectCreate(null);target._eventsCount=0}else{if(events.newListener){target.emit("newListener",type,listener.listener?listener.listener:listener);events=target._events}existing=events[type]}if(!existing){existing=events[type]=listener;++target._eventsCount}else{if(typeof existing==="function"){existing=events[type]=prepend?[listener,existing]:[existing,listener]}else{if(prepend){existing.unshift(listener)}else{existing.push(listener)}}if(!existing.warned){m=$getMaxListeners(target);if(m&&m>0&&existing.length>m){existing.warned=true;var w=new Error("Possible EventEmitter memory leak detected. "+existing.length+' "'+String(type)+'" listeners '+"added. Use emitter.setMaxListeners() to "+"increase limit.");w.name="MaxListenersExceededWarning";w.emitter=target;w.type=type;w.count=existing.length;if(typeof console==="object"&&console.warn){console.warn("%s: %s",w.name,w.message)}}}}return target}EventEmitter.prototype.addListener=function addListener(type,listener){return _addListener(this,type,listener,false)};EventEmitter.prototype.on=EventEmitter.prototype.addListener;EventEmitter.prototype.prependListener=function prependListener(type,listener){return _addListener(this,type,listener,true)};function onceWrapper(){if(!this.fired){this.target.removeListener(this.type,this.wrapFn);this.fired=true;switch(arguments.length){case 0:return this.listener.call(this.target);case 1:return this.listener.call(this.target,arguments[0]);case 2:return this.listener.call(this.target,arguments[0],arguments[1]);case 3:return this.listener.call(this.target,arguments[0],arguments[1],arguments[2]);default:var args=new Array(arguments.length);for(var i=0;i<args.length;++i)args[i]=arguments[i];this.listener.apply(this.target,args)}}}function _onceWrap(target,type,listener){var state={fired:false,wrapFn:undefined,target:target,type:type,listener:listener};var wrapped=bind.call(onceWrapper,state);wrapped.listener=listener;state.wrapFn=wrapped;return wrapped}EventEmitter.prototype.once=function once(type,listener){if(typeof listener!=="function")throw new TypeError('"listener" argument must be a function');this.on(type,_onceWrap(this,type,listener));return this};EventEmitter.prototype.prependOnceListener=function prependOnceListener(type,listener){if(typeof listener!=="function")throw new TypeError('"listener" argument must be a function');this.prependListener(type,_onceWrap(this,type,listener));return this};EventEmitter.prototype.removeListener=function removeListener(type,listener){var list,events,position,i,originalListener;if(typeof listener!=="function")throw new TypeError('"listener" argument must be a function');events=this._events;if(!events)return this;list=events[type];if(!list)return this;if(list===listener||list.listener===listener){if(--this._eventsCount===0)this._events=objectCreate(null);else{delete events[type];if(events.removeListener)this.emit("removeListener",type,list.listener||listener)}}else if(typeof list!=="function"){position=-1;for(i=list.length-1;i>=0;i--){if(list[i]===listener||list[i].listener===listener){originalListener=list[i].listener;position=i;break}}if(position<0)return this;if(position===0)list.shift();else spliceOne(list,position);if(list.length===1)events[type]=list[0];if(events.removeListener)this.emit("removeListener",type,originalListener||listener)}return this};EventEmitter.prototype.removeAllListeners=function removeAllListeners(type){var listeners,events,i;events=this._events;if(!events)return this;if(!events.removeListener){if(arguments.length===0){this._events=objectCreate(null);this._eventsCount=0}else if(events[type]){if(--this._eventsCount===0)this._events=objectCreate(null);else delete events[type]}return this}if(arguments.length===0){var keys=objectKeys(events);var key;for(i=0;i<keys.length;++i){key=keys[i];if(key==="removeListener")continue;this.removeAllListeners(key)}this.removeAllListeners("removeListener");this._events=objectCreate(null);this._eventsCount=0;return this}listeners=events[type];if(typeof listeners==="function"){this.removeListener(type,listeners)}else if(listeners){for(i=listeners.length-1;i>=0;i--){this.removeListener(type,listeners[i])}}return this};EventEmitter.prototype.listeners=function listeners(type){var evlistener;var ret;var events=this._events;if(!events)ret=[];else{evlistener=events[type];if(!evlistener)ret=[];else if(typeof evlistener==="function")ret=[evlistener.listener||evlistener];else ret=unwrapListeners(evlistener)}return ret};EventEmitter.listenerCount=function(emitter,type){if(typeof emitter.listenerCount==="function"){return emitter.listenerCount(type)}else{return listenerCount.call(emitter,type)}};EventEmitter.prototype.listenerCount=listenerCount;function listenerCount(type){var events=this._events;if(events){var evlistener=events[type];if(typeof evlistener==="function"){return 1}else if(evlistener){return evlistener.length}}return 0}EventEmitter.prototype.eventNames=function eventNames(){return this._eventsCount>0?Reflect.ownKeys(this._events):[]};function spliceOne(list,index){for(var i=index,k=i+1,n=list.length;k<n;i+=1,k+=1)list[i]=list[k];list.pop()}function arrayClone(arr,n){var copy=new Array(n);for(var i=0;i<n;++i)copy[i]=arr[i];return copy}function unwrapListeners(arr){var ret=new Array(arr.length);for(var i=0;i<ret.length;++i){ret[i]=arr[i].listener||arr[i]}return ret}function objectCreatePolyfill(proto){var F=function(){};F.prototype=proto;return new F}function objectKeysPolyfill(obj){var keys=[];for(var k in obj)if(Object.prototype.hasOwnProperty.call(obj,k)){keys.push(k)}return k}function functionBindPolyfill(context){var fn=this;return function(){return fn.apply(context,arguments)}}},{}],17:[function(require,module,exports){var process=module.exports={};var cachedSetTimeout;var cachedClearTimeout;function defaultSetTimout(){throw new Error("setTimeout has not been defined")}function defaultClearTimeout(){throw new Error("clearTimeout has not been defined")}(function(){try{if(typeof setTimeout==="function"){cachedSetTimeout=setTimeout}else{cachedSetTimeout=defaultSetTimout}}catch(e){cachedSetTimeout=defaultSetTimout}try{if(typeof clearTimeout==="function"){cachedClearTimeout=clearTimeout}else{cachedClearTimeout=defaultClearTimeout}}catch(e){cachedClearTimeout=defaultClearTimeout}})();function runTimeout(fun){if(cachedSetTimeout===setTimeout){return setTimeout(fun,0)}if((cachedSetTimeout===defaultSetTimout||!cachedSetTimeout)&&setTimeout){cachedSetTimeout=setTimeout;return setTimeout(fun,0)}try{return cachedSetTimeout(fun,0)}catch(e){try{return cachedSetTimeout.call(null,fun,0)}catch(e){return cachedSetTimeout.call(this,fun,0)}}}function runClearTimeout(marker){if(cachedClearTimeout===clearTimeout){return clearTimeout(marker)}if((cachedClearTimeout===defaultClearTimeout||!cachedClearTimeout)&&clearTimeout){cachedClearTimeout=clearTimeout;return clearTimeout(marker)}try{return cachedClearTimeout(marker)}catch(e){try{return cachedClearTimeout.call(null,marker)}catch(e){return cachedClearTimeout.call(this,marker)}}}var queue=[];var draining=false;var currentQueue;var queueIndex=-1;function cleanUpNextTick(){if(!draining||!currentQueue){return}draining=false;if(currentQueue.length){queue=currentQueue.concat(queue)}else{queueIndex=-1}if(queue.length){drainQueue()}}function drainQueue(){if(draining){return}var timeout=runTimeout(cleanUpNextTick);draining=true;var len=queue.length;while(len){currentQueue=queue;queue=[];while(++queueIndex<len){if(currentQueue){currentQueue[queueIndex].run()}}queueIndex=-1;len=queue.length}currentQueue=null;draining=false;runClearTimeout(timeout)}process.nextTick=function(fun){var args=new Array(arguments.length-1);if(arguments.length>1){for(var i=1;i<arguments.length;i++){args[i-1]=arguments[i]}}queue.push(new Item(fun,args));if(queue.length===1&&!draining){runTimeout(drainQueue)}};function Item(fun,array){this.fun=fun;this.array=array}Item.prototype.run=function(){this.fun.apply(null,this.array)};process.title="browser";process.browser=true;process.env={};process.argv=[];process.version="";process.versions={};function noop(){}process.on=noop;process.addListener=noop;process.once=noop;process.off=noop;process.removeListener=noop;process.removeAllListeners=noop;process.emit=noop;process.prependListener=noop;process.prependOnceListener=noop;process.listeners=function(name){return[]};process.binding=function(name){throw new Error("process.binding is not supported")};process.cwd=function(){return"/"};process.chdir=function(dir){throw new Error("process.chdir is not supported")};process.umask=function(){return 0}},{}]},{},[15]);
