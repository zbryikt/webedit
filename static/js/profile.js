function in$(t,e){for(var n=-1,a=e.length>>>0;++n<a;)if(t===e[n])return!0;return!1}var x$;x$=angular.module("webedit"),x$.controller("profile",["$scope","$http","$timeout","ldNotify"].concat(function(t,e,n,a){return t.user.data&&t.user.data.key?(t.settings={modal:{}},t.dnshint={modal:{}},t.displayname={value:t.user.data.displayname,update:function(){var n=this;if(this.value&&t.user.data.key)return t.loading=!0,e({url:"/d/user/"+t.user.data.key,method:"PUT",data:{displayname:this.value}})["finally"](function(){return t.loading=!1}).then(function(){return t.user.data.displayname=n.value,a.success("display name updated")})["catch"](function(){return a.danger("failed to update. try later?")})}},t.avatar={value:"/s/avatar/"+t.user.data.key+".png",sync:"",read:function(n,r){var i,u;return r&&/image\//.exec(r.type+"")?n.length>1048576?a.danger("image too large and should be smaller than 1MB"):(t.loading=!0,i=new Uint8Array(n),u=new FormData,u.append("image",new Blob([i],{type:"application/octet-stream"})),e({url:"/me/avatar",method:"PUT",data:u,transformRequest:angular.identity,headers:{"Content-Type":void 0}})["finally"](function(){return t.loading=!1}).then(function(){return a.success("avatar updated"),t.avatar.value="/s/avatar/"+t.user.data.key+".png?"+Math.random().toString(16).substring(2)})["catch"](function(){return a.danger("failed to update avatar. try later?")})):a.danger("this is not an image")}},t.passwd={n:"",o:"",error:{},update:function(){var r=this;return this.error={},t.loading=!0,e({url:"/d/me/passwd",method:"PUT",data:{n:this.n,o:this.o}})["finally"](function(){return n(function(){return t.loading=!1},1e3)}).then(function(){return a.success("password changed.")})["catch"](function(t){var e;return e=errcode.subcode((t.data||(t.data={})).code,"profile"),e[0]?r.error[e[0]]=!0:a.danger("failed changing password. try later?")})}},t.doc={loading:!0,list:[],cur:[],idx:0,pageAt:function(t){return this.list[t]||t--,this.cur=this.list[t],this.idx=t,this},fetch:function(){var t=this;return e({url:"/d/me/doc/",method:"GET"})["finally"](function(){return t.loading=!1}).then(function(e){return e.data.map(function(t){var e,n,a;for(t.timestamp=new Date(t.modifiedtime||t.createdtime).getTime(),t.thumbnail&&(t.thumbnail=t.thumbnail.replace(/\/\d+x\d+\//,"/80x42/")),t.permlist=[],e=0,n=(t.perm||[]).length;n>e;++e)a=e,t.permlist.push({displayname:t.perm_name[a],username:t.perm_email[a],perm:t.perm[a],key:t.perm_key[a]});return t.permlist.sort(function(t,e){return e.perm-t.perm})}),t.raw=e.data,t.prepare()})},"delete":function(t){var e;return e=this.raw.indexOf(t),~e?(this.raw.splice(e,1),this.prepare()):void 0},prepare:function(){var t,e,n,a,r;for(this.raw.sort(function(t,e){return e.timestamp-t.timestamp}),this.list=[],t=0,e=Math.floor(this.raw.length/20);e>=t;++t)for(n=t,this.list.push([]),a=0;20>a&&(r=a,!(20*n+r>=this.raw.length));++a)this.list[n].push(this.raw[20*n+r]);return this.cur=this.list[this.idx]}},t.doc.fetch(),t.page={perms:{perm:10,value:"",remove:function(n,r){return r&&n&&n.permlist.filter(function(t){return t.key===r}).length?(t.loading=!0,e({url:"/d/page/"+n.slug+"/perm/"+r,method:"DELETE"})["finally"](function(){return t.loading=!1}).then(function(){return n.permlist=n.permlist.filter(function(t){return t.key!==r}),a.send("success","deleted")})["catch"](function(){return a.send("danger","failed. try again later?")})):void 0},add:function(n){var r=this;if(this.value&&n)return t.loading=!0,e({url:"/d/page/"+n.slug+"/perm",method:"PUT",data:{emails:this.value,perm:this.perm}})["finally"](function(){return t.loading=!1}).then(function(t){var e,i;return e=(t.data||[]).map(function(t){return t.username.trim()}),t.data.map(function(t){return t.perm=r.perm}),i=(r.value||"").split(",").map(function(t){return t.trim()}).filter(function(t){return t}).filter(function(t){return!in$(t,e)}),i.length?(r.value=i.join(","),a.send("warning","some emails are not added.")):a.send("success","added."),n.permlist=(n.permlist||[]).concat(t.data)})["catch"](function(){return a.send("danger","failed. try again later?")})}},toggle:function(t,e){return t.target&&t.target.getAttribute&&/^item|ctrl|list/.exec(t.target.getAttribute("class"))?e.toggled=!e.toggled:void 0},"delete":function(n){return t.loading=!0,e({url:"/d/page/"+n.slug+"/",method:"DELETE"})["finally"](function(){return t.loading=!1}).then(function(){return t.doc["delete"](n),a.send("success","Deleted")})["catch"](function(){return a.send("danger","failed. try again later?")})},thumbnail:function(e){var n,a;return n="1024x1024",a=uploadcare.openDialog(null,null,{imageShrink:n,crop:"free"}),a.done(function(n){var a,r;return a=((r=n.files)?r():[n])[0],t.$apply(function(){return e.thumbnailLoading=!0}),a.done(function(n){return t.$apply(function(){return e.thumbnail=n.cdnUrl+"",e.thumbnailLoading=!1,t.page.update(e)})})})},update:function(n,r){return null==r&&(r=!1),t.loading=!0,e({url:"/d/page/"+n.slug+"/",method:"PUT",data:{title:n.title,thumbnail:n.thumbnail,domain:n.domain,path:n.path,gacode:n.gacode,tags:n.tags,privacy:n.privacy}})["finally"](function(){return t.loading=!1}).then(function(){return t.loading=!1,r&&(n.toggled=!1),a.send("success","saved.")})["catch"](function(){return alert("failed to save. try again later")})}}):(t.loading=!0,window.location.href="/auth/?nexturl=/me/")}));