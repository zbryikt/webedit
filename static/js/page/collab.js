var collab,x$;collab={action:{_info:function(t){var o,e,r,i,n;if(o=[t,collab.doc],e=o[0],r=o[1],!r.data)return[];for(;e&&e.parentNode&&!e.getAttribute("base-block");)e=e.parentNode;return e&&e.getAttribute&&e.getAttribute("base-block")?(i=Array.from(e.parentNode.childNodes).indexOf(e),n=e.getAttribute("base-block"),[e,r,i,n]):[]},moveBlock:function(t,o){return collab.doc.submitOp([{p:["child",t],lm:o}])},deleteBlock:function(t){var o,e,r,i,n;return o=this._info(t),e=o[0],r=o[1],i=o[2],n=o[3],e?r.submitOp([{p:["child",i],ld:r.data.child[i]}]):void 0},insertBlock:function(t){var o,e,r,i,n;return o=this._info(t),e=o[0],r=o[1],i=o[2],n=o[3],e?r.submitOp([{p:["child",i],li:{content:this.blockContent(e),type:n}}]):void 0},blockContent:function(t){var o;return o=Array.from(t.childNodes).filter(function(t){return/inner/.exec(t.getAttribute("class"))})[0],(o||{}).innerHTML},editBlock:function(t){var o,e,r,i,n,a,l,c,d,s,u,h=[];if(o=this._info(t),e=o[0],r=o[1],i=o[2],n=o[3],e){for(a={last:(r.data.child[i]||{}).content||"",now:this.blockContent(e)},l=fastDiff(a.last,a.now),r.data.child[i]||r.submitOp([{p:["child",i],li:{content:"",type:n}}]),c=0,d=0,s=l.length;s>d;++d)u=l[d],0===u[0]?h.push(c+=u[1].length):1===u[0]?(r.submitOp([{p:["child",i,"content",c],si:u[1]}]),h.push(c+=u[1].length)):h.push(r.submitOp([{p:["child",i,"content",c],sd:u[1]}]));return h}},cursor:function(t,o){return t&&collab.doc&&collab.doc.data?collab.doc.submitOp([{p:["collaborator",t.key,"cursor"],oi:o}]):void 0},join:function(t){var o;if(collab.doc&&collab.doc.data)return t||(t={displayname:"guest",key:Math.random().toString(16).substring(2),guest:!0}),collab.editor.collaborator.add(t,t.key),((o=collab.doc).collaborator||(o.collaborator={}))[t.key]?void 0:collab.doc.submitOp([{p:["collaborator",t.key],oi:(o={key:t.key,displayname:t.displayname,guest:t.guest},o.jointime=(new Date).getTime(),o)}])},exit:function(t){var o;if(collab.doc&&collab.doc.data)return((o=collab.doc.data).collaborator||(o.collaborator={}))[t.key]?(collab.editor.collaborator.remove(t,t.key),collab.doc.submitOp([{p:["collaborator",t.key],od:collab.doc.data.collaborator[t.key]}])):void 0}},init:function(t,o,e){var r,i,n,a,l=this;return r=[t,o],this.root=r[0],this.editor=r[1],i=window.location.pathname,this.socket=new WebSocket(("http"===o.server.scheme?"ws":"wss")+"://"+o.server.domain+"/ws"),n=function(){return o.online.toggle(!1)},this.socket.readyState>=2?n():(this.socket.addEventListener("close",function(t){return 3001!==t.code?n():void 0}),this.socket.addEventListener("error",function(){return 1===l.socket.readyState?n():void 0}),this.connection=new sharedb.Connection(this.socket),this.pageid=/^\/page\//.exec(i)?i.replace(/^\/page\//,"").replace(/\/$/,""):null,this.doc=a=this.connection.get("doc",this.pageid),a.on("load",function(){var t,e,r,i,n,l;if(a.data){for(t=0,r=(e=a.data.child).length;r>t;++t)i=t,n=e[t],o.block.prepare(n.content,n.type,i);for(l in e=a.data.collaborator)n=e[l],o.collaborator.add(n,l)}return o.loading.toggle(!1)}),a.fetch(function(){var t;return a.type||(t=a.create({attr:{},child:[],collaborator:{}})),a.subscribe(function(t,o){return l.handle(t,o)}),a.on("op",function(t,o){return l.handle(t,o)}),collab.action.join(e)}))},handle:function(t,o){function e(t){return/inner/.exec(t.getAttribute("class"))}var r,i,n,a,l,c,d,s,u=[];if(t&&!o){for(r=0,i=t.length;i>r;++r)n=t[r],n.si||n.sd?(a=this.root.childNodes[n.p[1]],l=Array.from(a.childNodes).filter(e)[0],l.innerHTML=this.doc.data.child[n.p[1]].content,u.push(this.editor.block.prepare(a,a.getAttribute("base-block"),n.p[1],!0))):n.li?u.push(this.editor.block.prepare(n.li.content,n.li.type,n.p[1])):n.ld?(a=this.root.childNodes[n.p[1]],u.push(a.parentNode.removeChild(a))):n.lm?(c=[n.p[1],n.lm],d=c[0],s=c[1],a=this.root.childNodes[d],this.root.removeChild(a),u.push(this.root.insertBefore(a,this.root.childNodes[s]))):n.oi?"collaborator"===n.p[0]&&u.push("cursor"===n.p[2]?this.editor.collaborator.update(this.doc.data.collaborator[n.p[1]],n.p[1]):this.editor.collaborator.add(n.oi,n.p[1])):n.od&&"collaborator"===n.p[0]&&u.push(this.editor.collaborator.remove(n.od,n.p[1]));return u}}},x$=angular.module("webedit"),x$.service("collaborate",["$rootScope"].concat(function(){return collab})),x$.controller("collabInfo",["$scope","$http"].concat(function(){var t;return t=document.querySelector("#collab-info"),t.style.left=800+Math.round((window.innerWidth-800)/2)+"px",t.style.right="auto"}));