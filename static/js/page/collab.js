function import$(t,e){var o={}.hasOwnProperty;for(var i in e)o.call(e,i)&&(t[i]=e[i]);return t}var collab,x$;collab={history:{backward:[],forward:[],redo:function(){var t;return(t=this.forward.splice(0,1)[0])?(backward.push(t),collab.doc.submitOp(t,{forceApply:!1})):void 0},undo:function(t){var e;return(e=this.backward.pop(t))?(this.forward.splice(0,0,e),collab.doc.submitOp(sharedb.types.map.json0.invert(e),{source:{forceApply:!0}})):void 0},log:function(t){return this.backward.push(t),this.forward.length?this.forward.splice(0):void 0}},action:{submitOp:function(t){return collab.history.log(t),collab.doc.submitOp(t)},info:function(t){var e,o,i,r,n,l;if(e=[t,collab.doc],o=e[0],i=e[1],!i||!i.data)return[];for(;o&&o.parentNode&&!o.getAttribute("base-block");)o=o.parentNode;return o&&o.getAttribute&&o.getAttribute("base-block")?(r=Array.from(o.parentNode.childNodes).indexOf(o),n=o.getAttribute("base-block"),l=o.getAttribute("eid"),[o,i,r,n,l]):[]},setPublic:function(t){var e,o;return e=collab.doc.data.attr,e&&e.isPublic!==t?this.submitOp([{p:["attr"],od:e,oi:(o=import$({},e),o.isPublic=t,o)}]):void 0},setThumbnail:function(t){var e,o;return null==t&&(t=null),t?(e=collab.doc,e.data.attr.thumbnail?(this.submitOp([{p:["attr","thumbnail",0],sd:e.data.attr.thumbnail}]),this.submitOp([{p:["attr","thumbnail",0],si:t}])):this.submitOp([{p:["attr"],od:e.data.attr,oi:(o=import$({},e.data.attr),o.thumbnail=t,o)}])):void 0},setTitle:function(t){var e=this;return this.setTitle.handler&&(clearTimeout(this.setTitle.handler),this.setTitle.handler=null),this.setTitle.handler=setTimeout(function(){var o,i,r,n;return o=collab.doc,i=t,i||(r=Array.from(document.querySelector("#editor .inner").querySelectorAll("h1,h2,h3")),r.sort(function(t,e){return t.nodeName===e.nodeName?0:t.nodeName>e.nodeName?1:-1}),r[0]&&(i=r[0].innerText)),i||(i="untitled"),o.data.attr.title!==i?(i.length>60&&(i=i.substring(0,57)+"..."),o.data.attr.title?(e.submitOp([{p:["attr","title",0],sd:o.data.attr.title}]),e.submitOp([{p:["attr","title",0],si:i}])):e.submitOp([{p:["attr"],oi:(n=import$({},o.data.attr),n.title=i,n)}])):void 0},1e3)},moveBlock:function(t,e){return this.submitOp([{p:["child",t],lm:e}])},deleteBlock:function(t){var e,o,i,r,n;return e=this.info(t),o=e[0],i=e[1],r=e[2],n=e[3],o?this.submitOp([{p:["child",r],ld:i.data.child[r]}]):void 0},insertBlock:function(t){var e,o,i,r,n,l;return e=this.info(t),o=e[0],i=e[1],r=e[2],n=e[3],l=e[4],o?(this.submitOp([{p:["child",r],li:{content:this.blockContent(o),type:n,eid:l}}]),this.setTitle()):void 0},blockContent:function(t){var e;return e=Array.from(t.childNodes).filter(function(t){return/inner/.exec(t.getAttribute("class"))})[0],e.querySelector("[auto-content]")&&(e=e.cloneNode(!0),Array.from(e.querySelectorAll("[auto-content]")).map(function(t){return Array.from(t.childNodes).map(function(e){return t.removeChild(e)})})),puredom.sanitize((e||{}).innerHTML)},strDiff:function(t,e,o){var i,r,n,l,a,s,c,d;for(null==t&&(t=[]),null==e&&(e=""),null==o&&(o=""),i=[collab.doc,fastDiff(e,o),0],r=i[0],n=i[1],l=i[2],a=[],s=0,c=n.length;c>s;++s)d=n[s],0===d[0]?l+=d[1].length:1===d[0]?(a.push({p:t.concat([l]),si:d[1]}),l+=d[1].length):a.push({p:t.concat([l]),sd:d[1]});return a.length?this.submitOp(a):void 0},editStyle:function(t,e){var o,i,r,n,l,a,s,c;if(null==e&&(e=!1),o=collab.doc,i=t.getAttribute("style"),e){if(i=i.replace(/width:\d+px;?/,""),r=[o.data,[]],n=r[0],l=r[1],n.style&&typeof n.style==typeof{}&&this.submitOp([{p:l.concat(["style"]),od:n.style}]),!n.style)return this.submitOp([{p:l,od:n,oi:(r=import$({},n),r.style=i,r)}])}else{if(r=this.info(t),a=r[0],o=r[1],s=r[2],c=r[3],!a||!o.data.child[s])return;if(r=[o.data.child[s],["child",s]],n=r[0],l=r[1],!n.style)return this.submitOp([{p:l,ld:n,li:(r=import$({},n),r.style=i,r)}])}return this.strDiff(l.concat(["style"]),n.style,i)},editBlock:function(t){var e,o,i,r,n,l,a,s;return e=this.info(t),o=e[0],i=e[1],r=e[2],n=e[3],o?(l={last:(i.data.child[r]||{}).content||"",now:this.blockContent(o)},a=fastDiff(l.last,l.now),i.data.child[r]||this.submitOp([{p:["child",r],li:{content:"",type:n,style:""}}]),s=0,this.strDiff(["child",r,"content"],l.last,l.now),this.setTitle()):void 0},cursor:function(t,e){var o;if(t&&(t.key||t.guestkey)&&collab.doc&&collab.doc.data)return o=t.key||t.guestkey,collab.connection.send({cursor:{action:"update",data:{cursor:e}}})}},init:function(t,e){var o,i,r,n,l=this;return o=[t,e],this.root=o[0],this.editor=o[1],this.root.innerHTML="",i=window.location.pathname,this.socket=new WebSocket(("http"===e.server.scheme?"ws":"wss")+"://"+e.server.domain+"/ws"),r=function(){return e.online.toggle(!1)},this.socket.readyState>=2?r():(this.socket.addEventListener("close",function(t){return 3001!==t.code?r():void 0}),this.socket.addEventListener("error",function(){return 1===l.socket.readyState?r():void 0}),this.connection=new sharedb.Connection(this.socket),this.connection.on("receive",function(t){var o,i;if(!t.data||t.data.cursor)return o=[t.data.cursor,null],i=o[0],t.data=o[1],e.collaborator.handle(i)}),this.pageid=/^\/page\//.exec(i)?i.replace(/^\/page\//,"").replace(/\/$/,""):null,this.doc=n=this.connection.get("doc",this.pageid),n.on("load",function(){var t,o,i,r,l;if(n.data){for(t=0,i=(o=n.data.child).length;i>t;++t)r=t,l=o[t],l&&e.block.prepare(l.content,{name:l.type,idx:r,redo:!1,style:l.style||"",source:!1,eid:l.eid});e.block.init(),e.page.prepare(n.data)}return e.loading.toggle(!1)}),n.fetch(function(t){var o;return t?e.online.toggle(!1,{code:403}):(n.type||(o=n.create({attr:{},style:"",child:[],collaborator:{}})),n.subscribe(function(t,e){return l.handle(t,e)}),n.on("op",function(t,e){return l.handle(t,e)}))}))},handle:function(t,e){var o,i,r,n,l,a,s,c,d=[];if(t&&(!e||e.forceApply)){for(o=0,i=t.length;i>o;++o)r=t[o],r.si||r.sd?"style"===r.p[2]?(n=this.root.childNodes[r.p[1]],d.push(n.style=this.doc.data.child[r.p[1]].style||"")):"style"===r.p[0]?d.push(this.root.style=this.doc.data.style||""):"attr"===r.p[0]||"child"===r.p[0]&&"content"===r.p[2]&&4===r.p.length&&(n=this.root.childNodes[r.p[1]],d.push(this.editor.block.prepareAsync(n,{name:n.getAttribute("base-block"),idx:r.p[1],redo:!0,content:this.doc.data.child[r.p[1]].content,source:!1}))):r.li?d.push(this.editor.block.prepare(r.li.content,{name:r.li.type,idx:r.p[1],redo:!1,style:r.li.style,source:!1,eid:r.li.eid})):r.ld?(n=this.root.childNodes[r.p[1]],d.push(n.parentNode.removeChild(n))):null!=r.lm?(l=[r.p[1],r.lm],a=l[0],s=l[1],a!==s&&(n=this.root.childNodes[a],c=this.root.childNodes[s+(s>a?1:0)],this.root.removeChild(n),d.push(c?this.root.insertBefore(n,c):this.root.appendChild(n)))):r.oi?"attr"===r.p[0]&&d.push(collab.editor.page.share.setPublic(this.doc.data.attr.isPublic)):r.od;return d}}},x$=angular.module("webedit"),x$.service("collaborate",["$rootScope"].concat(function(){return collab})),x$.controller("collabInfo",["$scope","$http"].concat(function(){var t;return t=document.querySelector("#collab-info"),t.style.left=1024+Math.round((window.innerWidth-1024)/2)+"px",t.style.right="auto"}));