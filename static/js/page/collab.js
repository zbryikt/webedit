function import$(t,e){var o={}.hasOwnProperty;for(var i in e)o.call(e,i)&&(t[i]=e[i]);return t}var collab,x$;collab={history:{backward:[],forward:[],redo:function(){for(var t;;){if(t=this.forward.splice(0,1)[0],!t)return;if(backward.push(t),collab.doc.submitOp(t.op,{forceApply:!1}),!t.option.nobreak)break}},undo:function(t){for(var e;;){if(e=this.backward.pop(t),!e)return;if(this.forward.splice(0,0,e),collab.doc.submitOp(sharedb.types.map.json0.invert(e.op),{source:{forceApply:!0}}),!e.option.nobreak)break}},log:function(t,e){return null==e&&(e={}),e.ignore?void 0:(this.backward.push({op:t,option:e}),this.forward.length?this.forward.splice(0):void 0)}},action:{submitOp:function(t,e){return null==e&&(e={}),collab.history.log(t,e),collab.doc.submitOp(t)},info:function(t){var e,o,i,r,n,a;if(e=[t,collab.doc],o=e[0],i=e[1],!i||!i.data)return[];for(;o&&o.parentNode&&!o.getAttribute("base-block");)o=o.parentNode;return o&&o.getAttribute&&o.getAttribute("base-block")?(r=Array.from(o.parentNode.childNodes).indexOf(o),n=o.getAttribute("base-block"),a=o.getAttribute("eid"),[o,i,r,n,a]):[]},checkPath:function(t,e,o,i){return null==o&&(o={}),null==i&&(i={ignore:!0}),t?void 0:this.submitOp([{p:e,oi:o}],i)},setPublic:function(t){var e,o;return this.checkPath(collab.doc.data.attr,["attr"]),e=collab.doc.data.attr,e&&e.isPublic!==t?this.submitOp([{p:["attr"],od:e,oi:(o=import$({},e),o.isPublic=t,o)}],{ignore:!0}):void 0},setThumbnail:function(t){var e,o;return null==t&&(t=null),t?(e=collab.doc,this.checkPath(e.data.attr,["attr"]),e.data.attr.thumbnail?this.submitOp([{p:["attr","thumbnail",0],sd:e.data.attr.thumbnail},{p:["attr","thumbnail",0],si:t}],{ignore:!0}):this.submitOp([{p:["attr"],od:e.data.attr,oi:(o=import$({},e.data.attr),o.thumbnail=t,o)}],{ignore:!0})):void 0},setTitle:function(t){var e=this;return this.setTitle.handler&&(clearTimeout(this.setTitle.handler),this.setTitle.handler=null),this.setTitle.handler=setTimeout(function(){var o,i,r,n;return o=collab.doc,i=t,i||(r=Array.from(document.querySelector("#editor .inner").querySelectorAll("h1,h2,h3")),r.sort(function(t,e){return t.nodeName===e.nodeName?0:t.nodeName>e.nodeName?1:-1}),r[0]&&(i=r[0].innerText)),i||(i="untitled"),e.checkPath(o.data.attr,["attr"]),o.data.attr&&o.data.attr.title===i?void 0:(i.length>60&&(i=i.substring(0,57)+"..."),o.data.attr&&o.data.attr.title?e.submitOp([{p:["attr","title",0],sd:o.data.attr.title},{p:["attr","title",0],si:i}],{ignore:!0}):e.submitOp([{p:["attr"],oi:(n=import$({},o.data.attr||{}),n.title=i,n)}],{ignore:!0}))},1e3)},moveBlock:function(t,e){return this.submitOp([{p:["child",t],lm:e}])},deleteBlock:function(t){var e,o,i,r,n;return e=this.info(t),o=e[0],i=e[1],r=e[2],n=e[3],o?this.submitOp([{p:["child",r],ld:i.data.child[r]}]):void 0},insertBlock:function(t){var e,o,i,r,n,a;return e=this.info(t),o=e[0],i=e[1],r=e[2],n=e[3],a=e[4],o?(this.submitOp([{p:["child",r],li:{content:this.blockContent(o),type:n,eid:a}}]),this.setTitle()):void 0},blockContent:function(t){var e;return e=Array.from(t.childNodes).filter(function(t){return/inner/.exec(t.getAttribute("class"))})[0],e.querySelector("[auto-content]")&&(e=e.cloneNode(!0),Array.from(e.querySelectorAll("[auto-content]")).map(function(t){return Array.from(t.childNodes).map(function(e){return t.removeChild(e)})})),puredom.sanitize((e||{}).innerHTML)},strDiff:function(t,e,o){var i,r,n,a,l,c,s,d;for(null==t&&(t=[]),null==e&&(e=""),null==o&&(o=""),i=[collab.doc,fastDiff(e,o),0],r=i[0],n=i[1],a=i[2],l=[],c=0,s=n.length;s>c;++c)d=n[c],0===d[0]?a+=d[1].length:1===d[0]?(l.push({p:t.concat([a]),si:d[1]}),a+=d[1].length):l.push({p:t.concat([a]),sd:d[1]});return l.length?this.submitOp(l):void 0},editStyle:function(t,e){var o,i,r,n,a,l,c,s;if(null==e&&(e=!1),o=collab.doc,i=t.getAttribute("style"),e){if(i=i.replace(/width:\d+px;?/,""),r=[o.data,[]],n=r[0],a=r[1],n.style&&typeof n.style==typeof{}&&this.submitOp([{p:a.concat(["style"]),od:n.style}]),!n.style)return this.submitOp([{p:a,od:n,oi:(r=import$({},n),r.style=i,r)}])}else{if(r=this.info(t),l=r[0],o=r[1],c=r[2],s=r[3],!l||!o.data.child[c])return;if(r=[o.data.child[c],["child",c]],n=r[0],a=r[1],!n.style)return this.submitOp([{p:a,ld:n,li:(r=import$({},n),r.style=i,r)}])}return this.strDiff(a.concat(["style"]),n.style,i)},editBlock:function(t){var e,o,i,r,n,a,l,c;return e=this.info(t),o=e[0],i=e[1],r=e[2],n=e[3],o?(a={last:(i.data.child[r]||{}).content||"",now:this.blockContent(o)},l=fastDiff(a.last,a.now),i.data.child[r]||this.submitOp([{p:["child",r],li:{content:"",type:n,style:""}}]),c=0,this.strDiff(["child",r,"content"],a.last,a.now),this.setTitle()):void 0},cursor:function(t,e){var o;if(t&&(t.key||t.guestkey)&&collab.doc&&collab.doc.data)return o=t.key||t.guestkey,collab.connection.send({cursor:{action:"update",data:{cursor:e}}})}},init:function(t,e){var o,i,r,n,a=this;return o=[t,e],this.root=o[0],this.editor=o[1],this.root.innerHTML="",i=window.location.pathname,this.socket=new WebSocket(("http"===e.server.scheme?"ws":"wss")+"://"+e.server.domain+"/ws"),r=function(){return e.online.toggle(!1)},this.socket.readyState>=2?r():(this.socket.addEventListener("close",function(t){return 3001!==t.code?r():void 0}),this.socket.addEventListener("error",function(){return 1===a.socket.readyState?r():void 0}),this.connection=new sharedb.Connection(this.socket),this.connection.on("receive",function(t){var o,i;if(!t.data||t.data.cursor)return o=[t.data.cursor,null],i=o[0],t.data=o[1],e.collaborator.handle(i)}),this.pageid=/^\/page\//.exec(i)?i.replace(/^\/page\//,"").replace(/\/$/,""):null,this.doc=n=this.connection.get("doc",this.pageid),n.on("load",function(){var t,o,i,r,a;if(n.data){for(t=0,i=(o=n.data.child).length;i>t;++t)r=t,a=o[t],a&&e.block.prepare(a.content,{name:a.type,idx:r,redo:!1,style:a.style||"",source:!1,eid:a.eid});e.block.init(),e.page.prepare(n.data)}return e.loading.toggle(!1),e.collaborator.init()}),n.fetch(function(t){var o;return t?e.online.toggle(!1,{code:403}):(n.type||(o=n.create({attr:{},style:"",child:[],collaborator:{}})),n.subscribe(function(t,e){return a.handle(t,e)}),n.on("op",function(t,e){return a.handle(t,e)}))}))},handle:function(t,e){var o,i,r,n,a,l,c,s,d=[];if(t&&(!e||e.forceApply)){for(o=0,i=t.length;i>o;++o)r=t[o],r.si||r.sd?"style"===r.p[2]?(n=this.root.childNodes[r.p[1]],d.push(n.style=this.doc.data.child[r.p[1]].style||"")):"style"===r.p[0]?d.push(this.root.style=this.doc.data.style||""):"attr"===r.p[0]||"child"===r.p[0]&&"content"===r.p[2]&&4===r.p.length&&(n=this.root.childNodes[r.p[1]],d.push(this.editor.block.prepareAsync(n,{name:n.getAttribute("base-block"),idx:r.p[1],redo:!0,content:this.doc.data.child[r.p[1]].content,source:!1}))):r.li?d.push(this.editor.block.prepare(r.li.content,{name:r.li.type,idx:r.p[1],redo:!1,style:r.li.style,source:!1,eid:r.li.eid})):r.ld?(n=this.root.childNodes[r.p[1]],d.push(n.parentNode.removeChild(n))):null!=r.lm?(a=[r.p[1],r.lm],l=a[0],c=a[1],l!==c&&(n=this.root.childNodes[l],s=this.root.childNodes[c+(c>l?1:0)],this.root.removeChild(n),d.push(s?this.root.insertBefore(n,s):this.root.appendChild(n)))):r.oi?"attr"===r.p[0]&&d.push(collab.editor.page.share.setPublic(this.doc.data.attr.isPublic)):r.od;return d}}},x$=angular.module("webedit"),x$.service("collaborate",["$rootScope"].concat(function(){return collab})),x$.controller("collabInfo",["$scope","$http"].concat(function(){var t;return t=document.querySelector("#collab-info"),t.style.left=1024+Math.round((window.innerWidth-1024)/2)+"px",t.style.right="auto"}));