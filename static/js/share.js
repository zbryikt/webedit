function handle(e,t){var n,i,r,o,d=[];if(e&&!t){for(n=0,i=e.length;i>n;++n)r=e[n],r.si?d.push(document.getElementById(r.p[1]).innerHTML=doc.data.child[r.p[1]].content):r.sd?d.push(document.getElementById(r.p[1]).innerHTML=doc.data.child[r.p[1]].content):r.oi?d.push(initBlock(r.p[1],r.oi.content)):r.od&&(o=document.getElementById(r.p[1]),d.push(o.parentNode.removeChild(o)));return d}}var socket,connection,pageid,doc,editEvent,initScript,mes,initBlock,templates,editable;socket=new WebSocket("ws://localhost:9000/"),connection=new sharedb.Connection(socket),pageid=window.location.pathname.replace(/\/page\//,"").replace(/\/$/,""),doc=connection.get("doc",pageid),doc.on("load",function(){var e,t,n,i=[];if(doc.data){for(e in t=doc.data.child)n=t[e],i.push(initBlock(e,n.content));return i}}),doc.fetch(function(){var e;return doc.type||(e=doc.create({attr:{},child:{}})),doc.subscribe(handle),doc.on("op",handle)}),editEvent=function(e){var t,n,i,r,o,d,c,a=[];if(doc.data&&(t=e.getAttribute("id"),e.getAttribute("contenteditable"))){for(n={last:(doc.data.child[t]||{}).content||"",now:e.innerHTML},i=fastDiff(n.last,n.now),r=0,doc.data.child[t]||doc.submitOp([{p:["child",t],oi:{content:""}}]),o=0,d=i.length;d>o;++o)c=i[o],0===c[0]?a.push(r+=c[1].length):1===c[0]?(doc.submitOp([{p:["child",t,"content",r],si:c[1]}]),a.push(r+=c[1].length)):a.push(doc.submitOp([{p:["child",t,"content",r],sd:c[1]}]));return a}},initScript=function(e){return new Promise(function(t){var n;return"undefined"!=typeof auxjs&&null!==auxjs&&auxjs[e]?t():(n=document.createElement("script"),n.src="/blocks/"+e+"/index.js",document.body.appendChild(n),n.onerror=function(){return t()},n.onload=function(){return t()})})},mes=[],initBlock=function(e,t,n){var i,r,o;return null==n&&(n=null),"string"==typeof e?(i=document.createElement("div"),i.innerHTML=t,i.setAttribute("id",e),i.setAttribute("class","widget")):i=e,n||(r=/data-widget="([^"]+)"/.exec(t),r&&(n=r[1])),i.addEventListener("dragstart",function(){return mes.map(function(e){return e.destroy()})}),i.addEventListener("dragend",function(){return mes.map(function(e){return e.setup()})}),i.addEventListener("click",function(e){var t;return/fa-close/.exec(e.target.getAttribute("class"))?(t=i.getAttribute("id"),this.parentNode.removeChild(this),doc.submitOp([{p:["child",t],od:doc.data.child[t]}])):void 0}),o=new MediumEditor(i.childNodes[0],{toolbar:{buttons:["colorPicker","anchor","justifyLeft","justifyCenter","justifyRight"]},extensions:{colorPicker:new ColorPickerExtension}}),mes.push(o),o.subscribe("editableInput",function(e,t){return editEvent(t)}),document.querySelector("#editor").appendChild(i),Promise.resolve().then(function(){return initScript(n)}).then(function(){return"undefined"!=typeof auxjs&&null!==auxjs&&auxjs[n]?auxjs[n](i):void 0})},templates={cache:{},get:function(e){var t=this;return new Promise(function(n){var i;return(i=t.cache[e])?n(i):$.ajax({url:"/blocks/"+e+"/index.html"}).done(function(i){return t.cache[e]=i,initScript(e).then(function(){return n(i)})})})}},Sortable.create(document.querySelector("#widgets"),{group:{name:"shared",pull:"clone"},disabled:!1,draggable:".widget"}),editable=Sortable.create(document.querySelector("#editor"),{handle:".handle",draggable:".widget",group:{name:"shared",pull:"clone"},onAdd:function(e){var t,n,i;return t=function(e){return"<div class='block' data-widget=\""+n+"\"><div class='handle'><div class='fa fa-bars'></div><div class='fa fa-close'></div></div>"+e+"</div>"},n=e.item.getAttribute("data-name"),e.item.style.backgroundImage="",console.log(n),i="id-"+Math.random().toString(16).substring(2),templates.get(n).then(function(r){var o;return o=t(r||"not found"),e.item.setAttribute("id",i),e.item.innerHTML=o,doc.submitOp([{p:["child",i],oi:{content:e.item.innerHTML}}]),initBlock(e.item,null,n)})}}),document.body.addEventListener("keyup",function(e){return editEvent(e.target)}),document.querySelector("#ctrl").addEventListener("mousedown",function(e){var t,n;if(t=e.target.getAttribute("class"),/btc/.exec(t)){for(n=Caret.node();n&&n.getAttribute&&!~(n.getAttribute("class")||"").indexOf("widget");)n=n.parentNode;if(!n||!n.getAttribute)return;return Caret.insert("<i class='fa'>&#xf2cd;</span>"),editEvent(n)}}),window.clone=function(){return window.location.href="/page/"+pageid+"/clone"},$.ajax({url:"/blocks/list.json"}).done(function(e){function t(){return mes.map(function(e){return e.destroy()})}function n(){return mes.map(function(e){return e.setup()})}var i,r,o,d,c,a=[];for(i=document.querySelector("#widgets"),r=0,o=e.length;o>r;++r)d=e[r],c=document.createElement("div"),c.setAttribute("class","widget"),c.setAttribute("data-name",d),c.style.backgroundImage="url(/blocks/"+d+"/index.svg)",c.innerHTML=d,i.appendChild(c),c.addEventListener("dragstart",t),a.push(c.addEventListener("dragend",n));return a});