var collab,x$;collab={action:{_info:function(o){var t,e,l,r,i;if(t=[o,collab.doc],e=t[0],l=t[1],!l.data)return[];for(;e&&e.parentNode&&!e.getAttribute("base-block");)e=e.parentNode;return e&&e.getAttribute&&e.getAttribute("base-block")?(r=Array.from(e.parentNode.childNodes).indexOf(e),i=e.getAttribute("base-block"),[e,l,r,i]):[]},moveBlock:function(o,t){return collab.doc.submitOp([{p:["child",o],lm:t}])},deleteBlock:function(o){var t,e,l,r,i;return t=this._info(o),e=t[0],l=t[1],r=t[2],i=t[3],e?l.submitOp([{p:["child",r],ld:l.data.child[r]}]):void 0},insertBlock:function(o){var t,e,l,r,i;return t=this._info(o),e=t[0],l=t[1],r=t[2],i=t[3],e?l.submitOp([{p:["child",r],li:{content:this.blockContent(e),type:i}}]):void 0},blockContent:function(o){return o.querySelector(".block-item > .inner").innerHTML},editBlock:function(o){var t,e,l,r,i,n,a,c,d,s,h,u=[];if(t=this._info(o),e=t[0],l=t[1],r=t[2],i=t[3],e){for(n={last:(l.data.child[r]||{}).content||"",now:this.blockContent(e)},a=fastDiff(n.last,n.now),l.data.child[r]||l.submitOp([{p:["child",r],li:{content:"",type:i}}]),c=0,d=0,s=a.length;s>d;++d)h=a[d],0===h[0]?u.push(c+=h[1].length):1===h[0]?(l.submitOp([{p:["child",r,"content",c],si:h[1]}]),u.push(c+=h[1].length)):u.push(l.submitOp([{p:["child",r,"content",c],sd:h[1]}]));return u}},join:function(o){var t;if(collab.doc&&collab.doc.data)return o||(o={displayname:"guest",key:Math.random().toString(16).substring(2),guest:!0}),collab.editor.collaborator.add(o,o.key),((t=collab.doc).collaborator||(t.collaborator={}))[o.key]?void 0:collab.doc.submitOp([{p:["collaborator",o.key],oi:(t={key:o.key,displayname:o.displayname,guest:o.guest},t.jointime=(new Date).getTime(),t)}])},exit:function(o){var t;if(collab.doc&&collab.doc.data)return((t=collab.doc.data).collaborator||(t.collaborator={}))[o.key]?(collab.editor.collaborator.remove(o,o.key),collab.doc.submitOp([{p:["collaborator",o.key],od:collab.doc.data.collaborator[o.key]}])):void 0}},init:function(o,t,e){var l,r,i,n=this;return l=[o,t],this.root=l[0],this.editor=l[1],r=window.location.pathname,this.socket=new WebSocket("ws://localhost:9000/"),this.connection=new sharedb.Connection(this.socket),this.pageid=/^\/page\//.exec(r)?r.replace(/^\/page\//,"").replace(/\/$/,""):null,this.doc=i=this.connection.get("doc",this.pageid),i.on("load",function(){var o,e,l,r,n,a,c=[];if(i.data){for(o=0,l=(e=i.data.child).length;l>o;++o)r=o,n=e[o],t.block.prepare(n.content,n.type,r);for(a in e=i.data.collaborator)n=e[a],c.push(t.collaborator.add(n,a));return c}}),i.fetch(function(){var o;return i.type||(o=i.create({attr:{},child:[],collaborator:{}})),i.subscribe(function(o,t){return n.handle(o,t)}),i.on("op",function(o,t){return n.handle(o,t)}),collab.action.join(e)})},handle:function(o,t){var e,l,r,i,n,a,c,d=[];if(o&&!t){for(e=0,l=o.length;l>e;++e)r=o[e],r.si||r.sd?d.push(this.root.childNodes[r.p[1]].querySelector(".block-item > .inner").innerHTML=this.doc.data.child[r.p[1]].content):r.li?d.push(this.editor.block.prepare(r.li.content,r.li.type,r.p[1])):r.ld?(i=this.root.childNodes[r.p[1]],d.push(i.parentNode.removeChild(i))):r.lm?(n=[r.p[1],r.lm],a=n[0],c=n[1],i=this.root.childNodes[a],this.root.removeChild(i),d.push(this.root.insertBefore(i,this.root.childNodes[c]))):r.oi?"collaborator"===r.p[0]&&d.push(this.editor.collaborator.add(r.oi,r.p[1])):r.od&&"collaborator"===r.p[0]&&d.push(this.editor.collaborator.remove(r.od,r.p[1]));return d}}},x$=angular.module("webedit"),x$.service("collaborate",["$rootScope"].concat(function(){return collab})),x$.controller("collabInfo",["$scope","$http"].concat(function(){var o;return o=document.querySelector("#collab-info"),o.style.left=800+Math.round((window.innerWidth-800)/2)+"px",o.style.right="auto"}));