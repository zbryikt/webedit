function in$(t,e){for(var a=-1,n=e.length>>>0;++a<n;)if(t===e[a])return!0;return!1}var x$;x$=angular.module("webedit"),x$.controller("profile",["$scope","$http","$timeout","ldNotify"].concat(function(t,e,a,n){return t.user.data&&t.user.data.key?(t.settings={modal:{}},t.displayname={value:t.user.data.displayname,update:function(){var a=this;if(this.value&&t.user.data.key)return t.loading=!0,e({url:"/d/user/"+t.user.data.key,method:"PUT",data:{displayname:this.value}})["finally"](function(){return t.loading=!1}).then(function(){return t.user.data.displayname=a.value,n.success("display name updated")})["catch"](function(){return n.danger("failed to update. try later?")})}},t.avatar={value:"/s/avatar/"+t.user.data.key+".png",sync:"",read:function(a,r){var i,u;return r&&/image\//.exec(r.type+"")?a.length>1048576?n.danger("image too large and should be smaller than 1MB"):(t.loading=!0,i=new Uint8Array(a),u=new FormData,u.append("image",new Blob([i],{type:"application/octet-stream"})),e({url:"/me/avatar",method:"PUT",data:u,transformRequest:angular.identity,headers:{"Content-Type":void 0}})["finally"](function(){return t.loading=!1}).then(function(){return n.success("avatar updated"),t.avatar.value="/s/avatar/"+t.user.data.key+".png?"+Math.random().toString(16).substring(2)})["catch"](function(){return n.danger("failed to update avatar. try later?")})):n.danger("this is not an image")}},t.passwd={n:"",o:"",error:{},update:function(){var r=this;return this.error={},t.loading=!0,e({url:"/d/me/passwd",method:"PUT",data:{n:this.n,o:this.o}})["finally"](function(){return a(function(){return t.loading=!1},1e3)}).then(function(){return n.success("password changed.")})["catch"](function(t){var e;return e=errcode.subcode((t.data||(t.data={})).code,"profile"),e[0]?r.error[e[0]]=!0:n.danger("failed changing password. try later?")})}},t.doc={list:[],cur:[],idx:0,pageAt:function(t){return this.list[t]||t--,console.log(t,this.list[t]),this.cur=this.list[t],this.idx=t,this},fetch:function(){var t=this;return e({url:"/d/me/doc/",method:"GET"}).then(function(e){return e.data.map(function(t){var e,a,n,r=[];for(t.timestamp=new Date(t.modifiedtime||t.createdtime).getTime(),t.thumbnail&&(t.thumbnail=t.thumbnail.replace(/\/\d+x\d+\//,"/80x42/")),t.permlist=[],e=0,a=(t.perm||[]).length;a>e;++e)n=e,r.push(t.permlist.push({displayname:t.perm_name[n],username:t.perm_email[n],perm:t.perm[n],key:t.perm_key[n]}));return r}),t.raw=e.data,t.prepare()})},"delete":function(t){var e;return e=this.raw.indexOf(t),~e?(this.raw.splice(e,1),this.prepare()):void 0},prepare:function(){var t,e,a,n,r;for(this.raw.sort(function(t,e){return e.timestamp-t.timestamp}),this.list=[],t=0,e=Math.floor(this.raw.length/20);e>=t;++t)for(a=t,this.list.push([]),n=0;20>n&&(r=n,!(20*a+r>=this.raw.length));++n)this.list[a].push(this.raw[20*a+r]);return this.cur=this.list[this.idx]}},t.doc.fetch(),t.page={perms:{perm:10,value:"",add:function(a){var r=this;if(this.value&&a)return t.loading=!0,e({url:"/d/page/"+a.slug+"/perm",method:"PUT",data:{emails:this.value,perm:this.perm}})["finally"](function(){return t.loading=!1}).then(function(t){var e,i;return e=(t.data||[]).map(function(t){return t.username.trim()}),t.data.map(function(t){return t.perm=r.perm}),i=(r.value||"").split(",").map(function(t){return t.trim()}).filter(function(t){return t}).filter(function(t){return!in$(t,e)}),i.length?(r.value=i.join(","),a.permlist=t.data||[],n.send("warning","some emails are not added.")):n.send("success","added.")})["catch"](function(){return n.send("danger","failed. try again later?")})}},toggle:function(t,e){return t.target&&t.target.getAttribute&&/^item|ctrl|list/.exec(t.target.getAttribute("class"))?e.toggled=!e.toggled:void 0},"delete":function(a){return t.loading=!0,e({url:"/d/page/"+a.slug+"/",method:"DELETE"})["finally"](function(){return t.loading=!1}).then(function(){return t.doc["delete"](a),n.send("success","Deleted")})["catch"](function(){return n.send("danger","failed. try again later?")})},thumbnail:function(e){var a,n;return a="1024x1024",n=uploadcare.openDialog(null,null,{imageShrink:a,crop:"free"}),n.done(function(a){var n,r;return n=((r=a.files)?r():[a])[0],t.$apply(function(){return e.thumbnailLoading=!0}),n.done(function(a){return t.$apply(function(){return e.thumbnail=a.cdnUrl+"",e.thumbnailLoading=!1,t.page.update(e)})})})},update:function(a,r){return null==r&&(r=!1),t.loading=!0,e({url:"/d/page/"+a.slug+"/",method:"PUT",data:{title:a.title,thumbnail:a.thumbnail,domain:a.domain,path:a.path,gacode:a.gacode,tags:a.tags,privacy:a.privacy}})["finally"](function(){return t.loading=!1}).then(function(){return t.loading=!1,r&&(a.toggled=!1),n.send("success","saved.")})["catch"](function(){return alert("failed to save. try again later")})}}):(t.loading=!0,window.location.href="/auth/?nexturl=/me/")}));