var collab,x$;collab={action:{_info:function(t){var e,o,n,i,r;if(e=[t,collab.doc],o=e[0],n=e[1],!n.data)return[];for(;o&&o.parentNode&&!o.getAttribute("base-block");)o=o.parentNode;return o&&o.getAttribute&&o.getAttribute("base-block")?(i=Array.from(o.parentNode.childNodes).indexOf(o),r=o.getAttribute("base-block"),[o,n,i,r]):[]},moveBlock:function(t,e){return console.log("move: ",t,e),collab.doc.submitOp([{p:["child",t],lm:e}])},deleteBlock:function(t){var e,o,n,i,r;return e=this._info(t),o=e[0],n=e[1],i=e[2],r=e[3],o?n.submitOp([{p:["child",i],ld:n.data.child[i]}]):void 0},insertBlock:function(t){var e,o,n,i,r;return e=this._info(t),o=e[0],n=e[1],i=e[2],r=e[3],o?n.submitOp([{p:["child",i],li:{content:this.blockContent(o),type:r}}]):void 0},blockContent:function(t){return t.querySelector(".block-item > .inner").innerHTML},editBlock:function(t){var e,o,n,i,r,c,l,a,h,s,d,u=[];if(e=this._info(t),o=e[0],n=e[1],i=e[2],r=e[3],o){for(c={last:(n.data.child[i]||{}).content||"",now:this.blockContent(o)},l=fastDiff(c.last,c.now),n.data.child[i]||n.submitOp([{p:["child",i],li:{content:"",type:r}}]),a=0,h=0,s=l.length;s>h;++h)d=l[h],0===d[0]?u.push(a+=d[1].length):1===d[0]?(n.submitOp([{p:["child",i,"content",a],si:d[1]}]),u.push(a+=d[1].length)):u.push(n.submitOp([{p:["child",i,"content",a],sd:d[1]}]));return u}}},init:function(t,e){var o,n,i,r=this;return o=[t,e],this.root=o[0],this.blockManager=o[1],n=window.location.pathname,this.socket=new WebSocket("ws://localhost:9000/"),this.connection=new sharedb.Connection(this.socket),this.pageid=/^\/page\//.exec(n)?n.replace(/^\/page\//,"").replace(/\/$/,""):null,this.doc=i=this.connection.get("doc",this.pageid),i.on("load",function(){var t,o,n,r,c,l=[];if(i.data){for(t=0,n=(o=i.data.child).length;n>t;++t)r=t,c=o[t],l.push(e.prepare(c.content,c.type,r));return l}}),i.fetch(function(){var t;return i.type||(t=i.create({attr:{},child:[]})),i.subscribe(function(t,e){return r.handle(t,e)}),i.on("op",function(t,e){return r.handle(t,e)})})},handle:function(t,e){var o,n,i,r,c,l,a,h=[];if(t&&!e){for(o=0,n=t.length;n>o;++o)i=t[o],i.si||i.sd?h.push(this.root.childNodes[i.p[1]].querySelector(".block-item > .inner").innerHTML=this.doc.data.child[i.p[1]].content):i.li?h.push(this.blockManager.prepare(i.li.content,i.li.type,i.p[1])):i.ld?(r=this.root.childNodes[i.p[1]],h.push(r.parentNode.removeChild(r))):i.lm&&(c=[i.p[1],i.lm],l=c[0],a=c[1],r=this.root.childNodes[l],this.root.removeChild(r),h.push(this.root.insertBefore(r,this.root.childNodes[a])));return h}}},x$=angular.module("webedit"),x$.service("collaborate",["$rootScope"].concat(function(){return collab})),x$.controller("collabInfo",["$scope","$http"].concat(function(){var t;return t=document.querySelector("#collab-info"),t.style.left=800+Math.round((window.innerWidth-800)/2)+"px",t.style.right="auto"}));